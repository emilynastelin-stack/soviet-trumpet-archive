<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Desktop filter debug page - composers</title>
  <style>
    body{ font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; padding:16px; background:#f6f7fb; }
    .toolbar{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e6e9ef; padding:8px 12px; display:flex; gap:8px; justify-content:center; z-index:5000}
    .toolbar button{ padding:8px 12px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer }
    #panel-left, #panel-right{ padding:12px; background:#fff; border-radius:8px; margin-bottom:12px }
    #results-list{ margin-top:12px }
    .result-card{ background:#fff; padding:10px; border-radius:8px; margin-bottom:8px }
    #mobileSidePanel{ display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.18); }
    #mobileSidePanel .panel-inner{ position:absolute; right:0; top:0; width:min(92%,420px); height:100vh; background:#fff; padding:12px; box-sizing:border-box }
  </style>
</head>
<body>
  <h1>Desktop filter debug page</h1>
  <p>This page contains an exact copy of the desktop filter panel and its wiring so you can test filter behavior in isolation. It does not change any site pages or scripts.</p>

  <!-- Desktop left filter panel (the scripts clone this element for mobile overlays) -->
  <div id="panel-left" aria-label="Left filter panel">
    <h3>Filters (desktop panel)</h3>
    <div id="filter-country" class="filter-group">
      <!-- populated by populateCountryCheckboxes() -->
    </div>
    <div id="filter-republic" class="filter-group">
      <!-- republic checkboxes -->
    </div>
    <div id="filter-decade" class="filter-group"></div>
    <div id="filter-type" class="filter-group"></div>
    <div id="filter-gender" class="filter-group"></div>
  </div>

  <!-- Desktop right composer panel (scripts clone this into mobile overlay) -->
  <div id="panel-right" aria-label="Composer panel">
    <div id="composer-content">
      <strong>Composer content (desktop)</strong>
      <p>Composer: Example Composer</p>
    </div>
    <div id="more-from-composer">More from composer</div>
    <button id="clear-composer">Clear composer</button>
  </div>

  <!-- Results list (used by mobile scripts) -->
  <div id="results-list">
    <div class="result-card">
      <div class="result-main"><b>Piece A</b><div>Composer: Example Composer</div></div>
      <div class="result-right"></div>
    </div>
    <div class="result-card">
      <div class="result-main"><b>Piece B</b><div>Composer: Another Composer</div></div>
      <div class="result-right"></div>
    </div>
  </div>

  <!-- Mobile side panel structure expected by the inline mobile script -->
  <div id="mobileSidePanel" aria-hidden="true">
    <div class="panel-inner" id="mobilePanelContent">
      <button id="closePanelBtn" type="button">Close</button>
      <div id="composer-content-mobile-clone"></div>
      <div id="panel-right-mobile-clone"></div>
    </div>
  </div>

  <!-- Footer toolbar with mobile filter button(s) the scripts bind to -->
  <div class="toolbar" role="toolbar">
    <button id="mf-filters" title="Filters">Filters</button>
    <button id="mf-center" title="Center">Center</button>
    <button id="mf-composers" title="Composers">Composers</button>
  </div>

  <!-- Toggle button used by some inline scripts -->
  <button id="togglePanelBtn" style="display:none">Toggle panel</button>

  <!-- Inline wiring for mobile filter panel (copied verbatim from page source) -->
  <script>
  (function(){
    // Prevent double-injection when the real client script is also present
    if (window.__mobileFilterWiringApplied) return; window.__mobileFilterWiringApplied = true;
    try{
      // Mobile overlay helpers: lock body scroll and allow independent scrolling in overlay panels.
      var quickMenu = null;
      try{ quickMenu = document.getElementById('mobile-swipe-menu'); }catch(_){ quickMenu = null; }
      var mfFiltersBtn = document.getElementById('mf-filters');

      function lockBody(){ try{ document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }catch(_){ } }
      function unlockBody(){ try{ document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }catch(_){ } }

      // Filter overlay (clones #panel-left into a mobile-friendly overlay)
      function openFilterOverlay(){
        if (document.getElementById('mobile-filter-overlay')) return;
        var left = document.getElementById('panel-left'); if (!left) return;
        var overlay = document.createElement('div'); overlay.id = 'mobile-filter-overlay'; overlay.className = 'mobile-swipe-menu'; overlay.setAttribute('aria-hidden','false');
        var inner = document.createElement('div'); inner.className = 'swipe-inner'; inner.setAttribute('role','menu'); inner.setAttribute('aria-label','Filters');
        var close = document.createElement('button'); close.className = 'swm-close'; close.textContent = 'Close'; close.addEventListener('click', function(e){ e && e.preventDefault && e.preventDefault(); closeFilterOverlay(); });
        inner.appendChild(close);
        try{ inner.style.overflow = 'auto'; inner.style.height = 'calc(100vh - 120px)'; inner.style.webkitOverflowScrolling = 'touch'; try{ overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.background = 'rgba(0,0,0,0.45)'; }catch(_){ } try{ inner.style.position = 'absolute'; inner.style.top = '64px'; inner.style.bottom = '56px'; inner.style.right = '0'; inner.style.left = 'auto'; inner.style.width = 'calc(100vw - 60px)'; inner.style.maxWidth = '92%'; inner.style.boxSizing = 'border-box'; inner.style.borderRadius = '8px 0 0 8px'; }catch(_){ } }catch(_){ }
        try{ document.querySelectorAll('.mobile-overlay.right').forEach(function(el){ try{ el.remove(); }catch(_){ } }); }catch(_){ }
        try{
          var clone = left.cloneNode(true);
          clone.id = 'panel-left-mobile-clone'; clone.classList.add('mobile-overlay-clone'); clone.style.margin = '0'; clone.style.width = '100%';
          clone.style.position = 'relative'; try{ clone.style.overflow = 'auto'; clone.style.maxHeight = '100%'; clone.style.height = '100%'; }catch(_){ }
          inner.appendChild(clone);
          try{ var fb = clone.querySelector && clone.querySelector('.filter-box'); if (fb){ fb.style.position = 'absolute'; fb.style.top = '60px'; fb.style.bottom = '0'; fb.style.left = '0'; fb.style.right = '0'; fb.style.overflowY = 'auto'; fb.style.webkitOverflowScrolling = 'touch'; fb.style.padding = '0 16px'; fb.style.boxSizing = 'border-box'; } }catch(_){ }
        }catch(_){
          try{
            var fallbackClone = document.createElement('div'); fallbackClone.id = 'panel-left-mobile-clone'; fallbackClone.classList.add('mobile-overlay-clone'); fallbackClone.style.margin = '0'; fallbackClone.style.width = '100%'; fallbackClone.style.position = 'static'; fallbackClone.style.overflow = 'auto'; fallbackClone.style.maxHeight = '100%'; fallbackClone.innerHTML = left.innerHTML || '';
            inner.appendChild(fallbackClone);
            try{ var fb2 = fallbackClone.querySelector && fallbackClone.querySelector('.filter-box'); if (fb2){ fb2.style.position = 'absolute'; fb2.style.top = '60px'; fb2.style.bottom = '0'; fb2.style.left = '0'; fb2.style.right = '0'; fb2.style.overflowY = 'auto'; fb2.style.webkitOverflowScrolling = 'touch'; fb2.style.padding = '0 16px'; fb2.style.boxSizing = 'border-box'; } }catch(_){ }
          }catch(_2){ try{ var ph = document.createElement('div'); ph.textContent = 'Filters'; inner.appendChild(ph); }catch(_3){} }
        }
        try{ overlay.style.zIndex = '100000'; overlay.style.pointerEvents = 'auto'; }catch(_){ }
        try{ inner.style.zIndex = '100001'; }catch(_){ }
        overlay.appendChild(inner);
        document.body.appendChild(overlay);
        try{ window.__mobileOverlayLock = 'filters'; }catch(_){ }
        try{
          var _savedScrollY = window.scrollY || document.documentElement.scrollTop || 0; overlay.__savedScrollY = _savedScrollY; document.body.style.position = 'fixed'; document.body.style.top = '-' + _savedScrollY + 'px'; document.body.style.left = '0'; document.body.style.right = '0'; document.body.style.width = '100%'; document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden';
        }catch(_){ try{ lockBody(); }catch(__){} }
        try{ inner.focus && inner.focus(); }catch(_){ }
        overlay.addEventListener('click', function(e){ if (e.target === overlay) closeFilterOverlay(); });
      }

      function closeFilterOverlay(){ var ov = document.getElementById('mobile-filter-overlay'); if (!ov) return; try{ var saved = ov.__savedScrollY || 0; ov.remove(); try{ if (window.__mobileOverlayLock === 'filters') window.__mobileOverlayLock = null; }catch(_){ } try{ document.body.style.position = ''; var top = document.body.style.top || ''; document.body.style.top = ''; document.body.style.left = ''; document.body.style.right = ''; document.body.style.width = ''; document.documentElement.style.overflow = ''; document.body.style.overflow = ''; if (saved) { window.scrollTo(0, saved); } }catch(_){ try{ unlockBody(); }catch(__){} } }catch(e){ try{ ov.remove(); }catch(_){ } try{ unlockBody(); }catch(__){} } }

      try{ if (mfFiltersBtn) mfFiltersBtn.addEventListener('click', function(e){ e && e.preventDefault && e.preventDefault(); try{ if (window.__mobileOverlayLock === 'filters') return; }catch(_){ } try{ if (document.querySelector('.mobile-overlay.left') || document.querySelector('.mobile-swipe-menu') || document.getElementById('mobile-filter-overlay')) return; }catch(_){ } openFilterOverlay(); }); }catch(_){ }

      // Prevent touchmove on document when an overlay is open; allow it when the
      // touchstart/target is inside a known scrollable overlay region
      document.addEventListener('touchmove', function(e){
        var qmOpen = quickMenu && quickMenu.getAttribute && quickMenu.getAttribute('aria-hidden') === 'false';
        var fo = document.getElementById('mobile-filter-overlay'); var foOpen = !!fo;
        if (!qmOpen && !foOpen && !document.querySelector('.mobile-overlay') && !document.getElementById('mobileSidePanel')) return;
        var allow = false;
        try{
          var target = e.target;
          if (target){ if (qmOpen){ var si = quickMenu.querySelector('.swipe-inner'); if (si && si.contains(target)) allow = true; } if (!allow && foOpen){ var si2 = fo.querySelector('.swipe-inner'); if (si2 && si2.contains(target)) allow = true; } if (!allow){ var nodes = document.querySelectorAll('.swipe-inner, .overlay-inner, .overlay-right-inner, .mobile-overlay-clone, #mobileSidePanel'); for (var i=0;i<nodes.length && !allow;i++){ try{ if (nodes[i] && nodes[i].contains(target)) allow = true; }catch(_){ } } } }
        }catch(_){ }
        if (!allow){ e.preventDefault && e.preventDefault(); }
      }, { passive: false });

      // Expose minimal helpers for debugging and compatibility
      window.openFilterOverlay = window.openFilterOverlay || openFilterOverlay;
      window.closeFilterOverlay = window.closeFilterOverlay || closeFilterOverlay;

    }catch(_){ }
  })();
  </script>

  <!-- Additional client overlay/filter wiring copied from composers-results.client.js -->
  <script>
  (function(){
    if (window.__clientMobileFilterWiringCopied) return; window.__clientMobileFilterWiringCopied = true;
    try{
      // openFilterOverlay (copied from public/composers-results.client.js)
      function openFilterOverlay(){
        if (window.innerWidth > 600) return;
        let overlay = document.querySelector('.mobile-overlay.left');
        if (overlay) return;
        overlay = document.createElement('div');
        overlay.className = 'mobile-overlay left';
        overlay.setAttribute('role','dialog');
        overlay.setAttribute('aria-modal','true');
        overlay.style.display = 'block';
        try{
          overlay.style.position = 'fixed';
          overlay.style.left = '0px';
          overlay.style.top = '0px';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.zIndex = '1990';
          overlay.style.background = 'rgba(0,0,0,0.18)';
        }catch(_){ overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.zIndex = '1990'; }

        const inner = document.createElement('div');
        inner.className = 'overlay-inner overlay-left-inner';
        inner.style.position = 'absolute';
        inner.style.top = '0';
        inner.style.bottom = '0';
        inner.style.left = '0';
        inner.style.right = 'auto';
        inner.style.width = 'min(84%, 380px)';
        inner.style.maxWidth = '380px';
        inner.style.zIndex = '1995';
        inner.style.background = 'white';
        inner.style.boxSizing = 'border-box';
        inner.style.padding = '16px';
        inner.style.transform = 'translateX(-8%)';
        inner.style.opacity = '0';
        inner.style.transition = 'transform 220ms ease, opacity 220ms ease';
        inner.style.boxShadow = '6px 0 18px rgba(0,0,0,0.12)';
        inner.style.borderTopRightRadius = '12px';
        inner.style.borderBottomRightRadius = '12px';

        const panel = document.getElementById('panel-left');
        if (panel){
          const clone = panel.cloneNode(true);
          clone.id = 'panel-left-mobile-clone';
          clone.classList.add('mobile-overlay-clone');
          clone.style.margin = '0';
          clone.style.padding = '0';
          clone.style.width = '100%';
          try{ clone.style.position = 'relative'; clone.style.overflow = 'auto'; clone.style.maxHeight = '100%'; clone.style.height = '100%'; }catch(_){ }
          inner.appendChild(clone);
          try{
            const fb = clone.querySelector && clone.querySelector('.filter-box');
            if (fb){
              fb.style.position = 'absolute';
              fb.style.top = '60px';
              fb.style.bottom = '0';
              fb.style.left = '0';
              fb.style.right = '0';
              fb.style.overflowY = 'auto';
              fb.style.webkitOverflowScrolling = 'touch';
              fb.style.padding = '0 16px';
              fb.style.boxSizing = 'border-box';
            }
          }catch(_){ }
        } else {
          inner.innerHTML = '<div style="padding:12px">Filters</div>';
        }

        overlay.appendChild(inner);
        document.body.appendChild(overlay);
        try{ window.__mobileOverlayLock = 'filters'; }catch(_){ }
        try{
          var _savedScrollY = window.scrollY || document.documentElement.scrollTop || 0;
          overlay.__savedScrollY = _savedScrollY;
          document.body.style.position = 'fixed';
          document.body.style.top = '-' + _savedScrollY + 'px';
          document.body.style.left = '0';
          document.body.style.right = '0';
          document.body.style.width = '100%';
          document.documentElement.style.overflow = 'hidden';
          document.body.style.overflow = 'hidden';
        }catch(_){ }

        overlay.addEventListener('click', (ev)=>{ if (ev.target === overlay) closeFilterOverlay(); });
        document.addEventListener('keydown', function onEsc(e){ if (e.key === 'Escape'){ closeFilterOverlay(); document.removeEventListener('keydown', onEsc); } });
        requestAnimationFrame(()=>{ inner.style.transform = 'translateX(0)'; inner.style.opacity = '1'; });
      }

      // restore body scroll and clear mobile overlay locks
      function clientRestoreBodyFromOverlay(overlay){
        try{
          if (!overlay) return;
          try{ var stillOpen = !!document.querySelector('.mobile-overlay, .mobile-swipe-menu, #mobileSidePanel'); if (stillOpen) return; }catch(_){ }
          try{ if (window.__mobileOverlayLock === 'filters' || window.__mobileOverlayLock === 'composer') window.__mobileOverlayLock = null; }catch(_){ }
          try{
            var saved = overlay.__savedScrollY || 0;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            if (saved) { try{ window.scrollTo(0, saved); }catch(_){ } }
          }catch(_){ try{ document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }catch(__){} }
        }catch(_){ }
      }

      function closeFilterOverlay(){
        const overlay = document.querySelector('.mobile-overlay.left');
        if (!overlay) return;
        const inner = overlay.querySelector('.overlay-inner.overlay-left-inner');
        if (inner){ inner.style.transform = 'translateX(-8%)'; inner.style.opacity = '0'; }
        setTimeout(()=>{
          try{
            const clone = document.getElementById('panel-left-mobile-clone');
            const real = document.getElementById('panel-left');
            if (clone && real){
              const cloneInputs = clone.querySelectorAll('input, select, textarea');
              cloneInputs.forEach(ci=>{
                try{
                  let selector = '';
                  if (ci.name) selector = '[name="' + ci.name + '"]';
                  else if (ci.dataset && ci.dataset.val) selector = '[data-val="' + ci.dataset.val + '"]';
                  else if (ci.value) selector = '[value="' + ci.value.replace(/"/g,'\"') + '"]';
                  if (!selector) return;
                  const orig = real.querySelector(selector);
                  if (!orig) return;
                  if (orig.type === 'checkbox' || orig.type === 'radio') orig.checked = ci.checked;
                  else orig.value = ci.value;
                }catch(_){ }
              });
            }
            try{ if (window.__mobileOverlayLock === 'filters') window.__mobileOverlayLock = null; }catch(_){ }
            try{
              var saved = overlay.__savedScrollY || 0;
              document.body.style.position = '';
              document.body.style.top = '';
              document.body.style.left = '';
              document.body.style.right = '';
              document.body.style.width = '';
              document.documentElement.style.overflow = '';
              document.body.style.overflow = '';
              if (saved) { window.scrollTo(0, saved); }
            }catch(_){ }
            try{ clientRestoreBodyFromOverlay(overlay); }catch(_){ }
            try{ overlay.remove(); }catch(_){ }
          }catch(_){ }
        }, 260);
      }

      // Right-side composer overlay (copied)
      function openComposerOverlay(){
        if (window.innerWidth > 600) return;
        let overlay = document.querySelector('.mobile-overlay.right');
        if (overlay) return;
        overlay = document.createElement('div');
        overlay.className = 'mobile-overlay right';
        overlay.setAttribute('role','dialog'); overlay.setAttribute('aria-modal','true'); overlay.style.display = 'block';
        try{ overlay.style.position = 'fixed'; overlay.style.left = '0px'; overlay.style.top = '0px'; overlay.style.width = '100vw'; overlay.style.height = '100vh'; overlay.style.zIndex = '1990'; overlay.style.background = 'rgba(0,0,0,0.18)'; }catch(_){ overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.zIndex='1990'; }
        const inner = document.createElement('div');
        inner.className = 'overlay-inner overlay-right-inner';
        inner.style.position = 'absolute'; inner.style.top = '0'; inner.style.bottom = '0'; inner.style.right = '0'; inner.style.left = 'auto';
        inner.style.width = 'min(92%, 420px)'; inner.style.maxWidth = '420px'; inner.style.zIndex = '1995'; inner.style.background = 'white'; inner.style.boxSizing = 'border-box'; inner.style.padding = '16px';
        inner.style.transform = 'translateX(8%)'; inner.style.opacity = '0'; inner.style.transition = 'transform 220ms ease, opacity 220ms ease';
        inner.style.boxShadow = '-6px 0 18px rgba(0,0,0,0.12)'; inner.style.borderTopLeftRadius = '12px'; inner.style.borderBottomLeftRadius = '12px';
        const panel = document.getElementById('panel-right');
        if (panel){
          const clone = panel.cloneNode(true);
          clone.id = 'panel-right-mobile-clone'; clone.classList.add('mobile-overlay-clone'); clone.style.margin='0'; clone.style.padding='0'; clone.style.width='100%';
          try{ clone.style.position = 'relative'; clone.style.overflow = 'auto'; clone.style.maxHeight = '100%'; clone.style.height = '100%'; }catch(_){ }
          inner.appendChild(clone);
          try{ const fb = clone.querySelector && clone.querySelector('.filter-box'); if (fb){ fb.style.overflowY = 'auto'; fb.style.webkitOverflowScrolling = 'touch'; } }catch(_){ }
        }
        else { inner.innerHTML = '<div style="padding:12px">Composer</div>'; }
        overlay.appendChild(inner); document.body.appendChild(overlay);
        try{ window.__mobileOverlayLock = 'composer'; }catch(_){ }
        try{ var _saved = window.scrollY || document.documentElement.scrollTop || 0; overlay.__savedScrollY = _saved; document.body.style.position = 'fixed'; document.body.style.top = '-' + _saved + 'px'; document.body.style.left = '0'; document.body.style.right = '0'; document.body.style.width = '100%'; document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }catch(_){ }
        overlay.addEventListener('click', (ev)=>{ if (ev.target === overlay) closeComposerOverlay(); });
        document.addEventListener('keydown', function onEsc(e){ if (e.key === 'Escape'){ closeComposerOverlay(); document.removeEventListener('keydown', onEsc); } });
        requestAnimationFrame(()=>{ inner.style.transform = 'translateX(0)'; inner.style.opacity = '1'; });
      }

      function closeComposerOverlay(){
        const overlay = document.querySelector('.mobile-overlay.right'); if (!overlay) return;
        const inner = overlay.querySelector('.overlay-inner.overlay-right-inner'); if (inner){ inner.style.transform = 'translateX(8%)'; inner.style.opacity = '0'; }
        setTimeout(()=>{
          try{
            const clone = document.getElementById('panel-right-mobile-clone');
            const real = document.getElementById('panel-right');
            if (clone && real){
              const cloneInputs = clone.querySelectorAll('input, select, textarea');
              cloneInputs.forEach(ci=>{
                try{
                  let selector = '';
                  if (ci.name) selector = '[name="' + ci.name + '"]';
                  else if (ci.dataset && ci.dataset.val) selector = '[data-val="' + ci.dataset.val + '"]';
                  else if (ci.value) selector = '[value="' + ci.value.replace(/"/g,'\"') + '"]';
                  if (!selector) return;
                  const orig = real.querySelector(selector); if (!orig) return;
                  if (orig.type === 'checkbox' || orig.type === 'radio') orig.checked = ci.checked; else orig.value = ci.value;
                }catch(_){ }
              });
            }
            try{ if (window.__mobileOverlayLock === 'composer') window.__mobileOverlayLock = null; }catch(_){ }
            try{ var saved = overlay.__savedScrollY || 0; document.body.style.position = ''; document.body.style.top = ''; document.body.style.left = ''; document.body.style.right = ''; document.body.style.width = ''; document.documentElement.style.overflow = ''; document.body.style.overflow = ''; if (saved) window.scrollTo(0, saved); }catch(_){ }
            try{ clientRestoreBodyFromOverlay(overlay); }catch(_){ }
            try{ overlay.remove(); }catch(_){ }
          }catch(_){ }
        }, 260);
      }

      // Wire the mobile filters button: toggle a left-side overlay on small screens; otherwise scroll the left panel into view
      try{ const mfFilters = document.getElementById('mf-filters'); if (mfFilters) mfFilters.addEventListener('click', (ev)=>{ ev.preventDefault(); const existing = document.querySelector('.mobile-overlay.left'); if (window.innerWidth <= 600) { if (existing) closeFilterOverlay(); else openFilterOverlay(); } else { const el = document.getElementById('panel-left'); if (el) el.scrollIntoView({behavior:'smooth', block:'center'}); } }); }catch(_){ }

      // Defensive global click handler to ensure mf-filters works if other bindings removed
      try{
        document.addEventListener('click', function(e){
          try{
            const hit = e.target && e.target.closest ? e.target.closest('#mf-filters') : null;
            if (!hit) return;
            e.preventDefault && e.preventDefault();
            if (window.innerWidth <= 600){
              if (typeof window.openFilterOverlay === 'function') window.openFilterOverlay(); else if (typeof openFilterOverlay === 'function') openFilterOverlay();
            } else {
              const el = document.getElementById('panel-left'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }catch(_){ }
        });
      }catch(_){ }

      // Expose for debug
      window.openFilterOverlay = window.openFilterOverlay || openFilterOverlay;
      window.closeFilterOverlay = window.closeFilterOverlay || closeFilterOverlay;
      window.openComposerOverlay = window.openComposerOverlay || openComposerOverlay;
      window.closeComposerOverlay = window.closeComposerOverlay || closeComposerOverlay;

    }catch(_){ }
  })();
  </script>

  <!-- Load mobile-side scripts from the public folder (kept unmodified) -->
  <script src="./composers-results.inline.1.js"></script>
  <script src="./composers-results.client.js"></script>

  <p style="font-size:0.9rem;color:#6b7280;margin-top:12px">Open your browser devtools and emulate a mobile viewport to exercise overlays (scripts are not modified).</p>
  
  <!-- Lightweight client-side DOM filter for the debug page
       This does not modify any existing scripts; it provides a small,
       local-only filtering layer so #results-list can be filtered by
       the checkboxes and an optional search input while testing. -->
  <script>
  (function(){
    if (window.__mobileDomFilterAdded) return; window.__mobileDomFilterAdded = true;
    // simple normalize (lowercase, collapse whitespace)
    function norm(s){ try{ return String(s||'').replace(/\s+/g,' ').trim().toLowerCase(); }catch(e){ return String(s||'').toLowerCase(); } }

    function getChecked(selector){
      try {
        // Prefer the mobile clone if it exists, otherwise fallback to desktop panel
        const base = document.querySelector('#panel-left-mobile-clone') || document.querySelector('#panel-left');
        if (!base) return [];
        return Array.from(base.querySelectorAll(selector + ' input[type=checkbox]:checked'))
          .map(cb => decodeURIComponent(cb.dataset.val || cb.getAttribute('data-val') || (cb.nextSibling && cb.nextSibling.textContent) || cb.value || '').trim())
          .filter(Boolean);
      } catch (e) { return []; }
    }

    function cardMatches(card, q, countries, decades, types, genders, republics){
      const text = norm(card.innerText || '');
      if (q && !text.includes(q)) return false;
      const matchesAny = (arr)=>{ if (!arr || !arr.length) return true; return arr.some(v => v && text.includes(norm(v))); };
      if (!matchesAny(countries)) return false;
      if (!matchesAny(decades)) return false;
      if (!matchesAny(types)) return false;
      if (!matchesAny(genders)) return false;
      if (!matchesAny(republics)) return false;
      return true;
    }

    function filterResults(){
      try{
        const qinput = document.getElementById('qinput');
        const q = qinput ? norm(qinput.value || '') : '';
        const countries = getChecked('#filter-country');
        const decades = getChecked('#filter-decade');
        const types = getChecked('#filter-type');
        const genders = getChecked('#filter-gender');
        const republics = getChecked('#filter-republic');
        const list = document.getElementById('results-list');
        if (!list) return;
        const cards = Array.from(list.querySelectorAll('.result-card'));
        let shown = 0;
        cards.forEach(card => {
          try{
            const ok = cardMatches(card, q, countries, decades, types, genders, republics);
            card.style.display = ok ? '' : 'none';
            if (ok) shown++;
          }catch(_){ }
        });
        // optional debug: update a small badge if present
        try{ const dbg = document.getElementById('cr-debug'); if (dbg) dbg.textContent = 'filtered: ' + shown; }catch(_){ }
      }catch(e){ console.error('filterResults failed', e); }
    }

    // Attach handlers to checkboxes inside the panel-left clone or original
    function attachBindings(){
      try{
        const selectors = ['#filter-country', '#filter-decade', '#filter-type', '#filter-gender', '#filter-republic'];
        selectors.forEach(sel => {
          try{
            const el = document.querySelector(sel);
            if (!el) return;
            el.querySelectorAll('input[type=checkbox]').forEach(cb => {
              // remove any prior change handlers added previously to avoid duplicates
              try{ cb.removeEventListener('change', cb.__desktopDebugHandler || filterResults); }catch(_){ }

              // handler to sync counterpart checkbox and run filterResults
              const handler = function onChange(){
                try{
                  const name = cb.name;
                  const value = cb.value;
                  const checked = cb.checked;
                  // determine counterpart panel
                  const inDesktop = !!cb.closest('#panel-left');
                  const desktopPanel = document.querySelector('#panel-left');
                  const mobilePanel = document.querySelector('#panel-left-mobile-clone');
                  const targetPanel = inDesktop ? mobilePanel || desktopPanel : desktopPanel || mobilePanel;
                  if (targetPanel){
                    // find matching checkbox by name+value inside counterpart
                    const match = Array.from(targetPanel.querySelectorAll(`input[name="${name}"]`)).find(x => String(x.value) === String(value));
                    if (match && match !== cb){
                      try{ match.checked = checked; }catch(_){ }
                    }
                  }
                }catch(_){ }
                try{ filterResults(); }catch(_){ }
              };

              // store reference so we can remove it later if needed
              cb.__desktopDebugHandler = handler;
              cb.addEventListener('change', handler);
            });
          }catch(_){ }
        });
        // optional search input
        const qinput = document.getElementById('qinput');
        if (qinput){ qinput.removeEventListener('input', filterResults); qinput.addEventListener('input', filterResults); }
      }catch(e){ console.warn('attachBindings', e); }
    }

    // Run attach on DOMContentLoaded and also after the mobile overlay clones are created
    document.addEventListener('DOMContentLoaded', function(){ attachBindings(); filterResults(); });
    // observe for panel-left-mobile-clone being inserted and reattach bindings
    try{
      const obs = new MutationObserver(function(m){ for (const rec of m){ for (const n of rec.addedNodes || []){ try{ if (n && n.id === 'panel-left-mobile-clone') { attachBindings(); filterResults(); } }catch(_){} } } });
      obs.observe(document.body, { childList: true, subtree: true });
    }catch(_){ }

    // expose for manual testing
    window.mobileDebugFilter = { filterResults, attachBindings };
  })();
  </script>
</body>
</html>