let l=null,m=localStorage.getItem("locale")||"en";const u=document.getElementById("langBtn"),d=document.getElementById("langDropdown"),V=document.getElementById("langToggle");async function Y(){try{l=await(await fetch("/i18n/translations.json")).json()}catch(e){console.error("Failed to load translations",e),l=null}}function $(e){m=e,localStorage.setItem("locale",e);const n=(l&&l[e]?l[e]:l&&l.en?l.en:null)||{placeholder:"Search composers, countries, or pieces...",search:"Search",showAll:"Show All",reset:"Reset Filters",loading:"Loading…",enterSearch:'Enter a search or click "Show All" to display results.',labels:{native:"Native",compositions:"Composition(s)",year:"Year",type:"Type",nationality:"Nationality",country:"Country",gender:"Gender",leader:"Leader",source:"Source"},navEnglish:"Archive of Soviet Trumpet Music",heroTitle:"Discover Soviet-era trumpet music",heroSubtitle:"Search composers and pieces from across the Soviet republics.",decades:["1920s","1930s","1940s","1950s","1960s","1970s","1980s"],countries:["Russia","Ukraine","Belarus","Armenia","Georgia","Latvia","Estonia","Lithuania","Kazakhstan","Uzbekistan","Other"],genderOptions:["Male","Female","Other"]};h.placeholder=n.placeholder,M.textContent=n.search,O.textContent=n.showAll,document.getElementById("resetFilters").textContent=n.reset,document.getElementById("resultsCount").textContent="",g.textContent="",i.innerHTML=`<div class="muted">${n.enterSearch}</div>`,u.textContent=e==="en"?"EN ▾":"DE ▾",document.getElementById("navEnglish").textContent=n.navEnglish||document.getElementById("navEnglish").textContent;const r=document.querySelector(".search-panel h1"),s=document.querySelector(".search-panel p.muted");r&&(r.textContent=n.heroTitle||r.textContent),s&&(s.textContent=n.heroSubtitle||s.textContent);const a=document.getElementById("decadeFilter"),k=document.getElementById("countryFilter"),j=document.getElementById("genderFilter");function L(B,F,S,b){if(!B)return;let T=`<option value="All">${n&&n[b]?n[b]:b}</option>`;for(let x=0;x<F.length;x++){const D=F[x],P=S&&S[x]?S[x]:D;T+=`<option value="${encodeURIComponent(String(D))}">${P}</option>`}B.innerHTML=T}const f=l&&l.en?l.en:null,N=f?f.decades:n.decades||[],z=f?f.countries:n.countries||[],G=f?f.genderOptions:n.genderOptions||[];L(a,N,n.decades,"filterDecade"),L(k,z,n.countries,"filterCountry"),L(j,G,n.genderOptions,"filterGender"),c&&c.length&&(A||document.getElementById("results").children.length>0)&&C()}u.addEventListener("click",e=>{d.classList.toggle("open"),u.setAttribute("aria-expanded",d.classList.contains("open"))});u.setAttribute("aria-haspopup","listbox");u.setAttribute("aria-expanded","false");u.addEventListener("keydown",e=>{(e.key==="ArrowDown"||e.key==="Enter"||e.key===" ")&&(e.preventDefault(),d.classList.add("open"),d.querySelector(".lang-option").focus())});d.addEventListener("click",e=>{const o=e.target.closest(".lang-option");if(!o)return;const t=o.dataset.locale;$(t),d.classList.remove("open"),u.setAttribute("aria-expanded","false")});d.addEventListener("keydown",e=>{const o=Array.from(d.querySelectorAll(".lang-option")),t=o.indexOf(document.activeElement);if(e.key==="ArrowDown"){e.preventDefault();const n=o[(t+1)%o.length];n&&n.focus()}if(e.key==="ArrowUp"){e.preventDefault();const n=o[(t-1+o.length)%o.length];n&&n.focus()}(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),document.activeElement.click()),e.key==="Escape"&&(d.classList.remove("open"),u.focus())});document.addEventListener("click",e=>{V.contains(e.target)||(d.classList.remove("open"),u.setAttribute("aria-expanded","false"))});function p(e){if(!e)return"";try{return e.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase()}catch{return e.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}}const h=document.getElementById("q"),M=document.getElementById("searchBtn"),O=document.getElementById("showAll"),v=document.getElementById("genderFilter"),E=document.getElementById("decadeFilter"),w=document.getElementById("countryFilter"),i=document.getElementById("results"),I=document.getElementById("resultsCount"),g=document.getElementById("statusMsg");let c=[],R=[],A=!1;async function y(){g.innerHTML='<span class="spinner"><svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="25" r="20" fill="none" stroke="#8b0000" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4"/></svg></span>Loading…';const e=document.getElementById("debugFetch");e&&(e.textContent="Starting fetch...");try{const o=(window.location&&window.location.origin?window.location.origin:"")+"/api/sheets?_="+Date.now();e&&(e.textContent="fetching "+o);const t=await fetch(o,{method:"GET",mode:"same-origin",cache:"no-store"});if(!t.ok){const r=await t.text();throw new Error("Fetch failed: "+t.status+" "+r)}const n=await t.json();if(e&&(e.textContent=`fetch ok, rows=${Array.isArray(n)?n.length:"?"} `),!Array.isArray(n)||n.length===0){c=[],i.innerHTML='<div class="muted">No data available</div>',g.textContent="",I.textContent="";return}c=n,R=Object.keys(c[0]||{}),g.textContent="",e&&(e.textContent+=" loaded headers="+R.length),I.textContent="",i.innerHTML='<div class="muted">Enter a search or click "Show All" to display results.</div>'}catch(o){console.error(o),g.textContent="Failed to load data",i.innerHTML=`<div class="muted">Error loading data: ${String(o)}</div>`,e&&(e.textContent="fetch error: "+String(o))}}function C(){A=!0;const e=p(h.value||""),o=v.value||"All",t=E.value||"All",n=w.value||"All";let r=c.slice();e&&(r=r.filter(s=>p(Object.values(s||{}).join(" ")).includes(e))),o!=="All"&&(r=r.filter(s=>p(s.Gender||s.gender||"").includes(p(o)))),t!=="All"&&(r=r.filter(s=>(s.Decade||"").toString()===t)),n!=="All"&&(r=r.filter(s=>p(s.Country||s.Nationality||"").includes(p(n)))),J()}function _(){try{(i&&i.querySelectorAll?i.querySelectorAll(".card"):document.querySelectorAll(".card")).forEach(o=>{const t=o.querySelector(".card-content"),n=o.querySelector(".card-header");if(t)if(o.classList.contains("open"))t.style.display="block",t.style.pointerEvents="",t.style.opacity="0",t.style.maxHeight="0px",requestAnimationFrame(()=>{try{t.style.maxHeight=(t.scrollHeight||t.offsetHeight||0)+"px",t.style.opacity="1"}catch{}}),n&&n.setAttribute("aria-expanded","true");else{try{t.style.pointerEvents="none",t.style.opacity="0",t.style.maxHeight=(t.scrollHeight||t.offsetHeight||0)+"px",t.offsetHeight,requestAnimationFrame(()=>{t.style.maxHeight="0px"});const r=function(){try{t.style.display="none"}catch{}finally{t.removeEventListener("transitionend",r)}};t.addEventListener("transitionend",r)}catch{t.style.display="none",t.style.maxHeight="0px",t.style.opacity="0"}n&&n.setAttribute("aria-expanded","false")}})}catch{}}function J(e){l&&l[m]?l[m]:l&&l.en&&l.en,i.innerHTML="";const o=document.createElement("div");o.innerHTML=`
    <div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #eee;">
      <p style="margin:0 0 8px">Results are shown on a dedicated page. Click the button below to open a plain results view (unstyled).</p>
      <div><button id="openResultsInline" class="small-btn">Open results page</button></div>
    </div>`,i.appendChild(o);const t=document.getElementById("openResultsInline");t&&t.addEventListener("click",()=>{const n=encodeURIComponent(h.value||""),r=encodeURIComponent(v.value||"All"),s=encodeURIComponent(E.value||"All"),a=encodeURIComponent(w.value||"All"),k=`/composers-results?q=${n}&gender=${r}&decade=${s}&country=${a}`;window.location.href=k})}function U(){const e=encodeURIComponent(h.value||""),o=encodeURIComponent(v.value||"All"),t=encodeURIComponent(E.value||"All"),n=encodeURIComponent(w.value||"All"),r=`/composers-results?q=${e}&gender=${o}&decade=${t}&country=${n}`;window.location.href=r}M.addEventListener("click",U);h.addEventListener("keydown",e=>{e.key==="Enter"&&U()});v.addEventListener("change",C);E.addEventListener("change",C);w.addEventListener("change",C);O.addEventListener("click",()=>{h.value="",v.value="All",E.value="All",w.value="All",A=!0;const e="/composers-results?q=&gender=All&decade=All&country=All";window.location.href=e});const K=document.getElementById("resetFilters");K.addEventListener("click",()=>{h.value="",v.value="All",E.value="All",w.value="All",A=!1,i.innerHTML='<div class="muted">Enter a search or click "Show All" to display results.</div>',I.textContent="",g.textContent="";try{_()}catch{}});(async function(){try{l||await Y();try{$(m)}catch(e){console.error("applyLocale failed",e)}g.textContent=l&&l[m]&&l[m].loading?l[m].loading:"Loading…",await y()}catch(e){console.error("Initial load error",e),g.textContent="Initialization failed",i.innerHTML=`<div class="muted">Initialization error: ${String(e)}</div>`}})();setTimeout(()=>{const e=document.getElementById("debugFetch");if(e&&(e.textContent=(e.textContent||"")+" [watchdog check]"),!c||c.length===0)try{y()}catch(o){console.error("watchdog fetch failed",o)}},1e3);if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{try{y()}catch{}});else try{y()}catch{}const q=document.getElementById("debugRetry");q&&q.addEventListener("click",()=>{y()});const H=Array.from(document.querySelectorAll(".cta-add")).find(e=>/randomize/i.test(e.textContent||""));H&&H.addEventListener("click",async e=>{e.preventDefault();try{if((!c||c.length===0)&&await y(),!c||c.length===0)return;const o=c.find(a=>a&&Object.keys(a).length);let t=null;if(o){for(const a of Object.keys(o))if(/composer/i.test(a)||/композитор/i.test(a)){t=a;break}}t||(t=Object.keys(c[0])[0]);const n=c.map(a=>a&&a[t]?String(a[t]).trim():"").filter(Boolean);if(!n||n.length===0)return;const r=n[Math.floor(Math.random()*n.length)],s=`/composers-results?q=${encodeURIComponent(r)}&random=1`;window.location.href=s}catch(o){console.error("Randomize redirect failed",o)}});(function(){const e=()=>document.getElementById("debugFetch");window.onerror=function(o,t,n,r,s){try{const a=e();a&&(a.textContent=`onerror: ${o} at ${t}:${n}:${r}`)}catch{}return!1},window.onunhandledrejection=function(o){try{const t=e();t&&(t.textContent=`unhandledrejection: ${String(o.reason)}`)}catch{}},setTimeout(()=>{try{const o=e();if(o&&/Starting fetch|fetching/.test(o.textContent||""))return;y().catch(t=>{const n=e();n&&(n.textContent="retry fetch failed: "+String(t))})}catch{}},1200)})();
