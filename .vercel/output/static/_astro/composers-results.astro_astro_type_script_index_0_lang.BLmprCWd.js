const Te=new URLSearchParams(window.location.search),Ie=Te.get("q")||"",J=document.getElementById("qinput");J.placeholder="Search composers, countries, or pieces...";J.value=decodeURIComponent(Ie);const X=document.getElementById("langBtn"),Q=document.getElementById("langDropdown");X&&Q&&(X.addEventListener("click",()=>{Q.classList.toggle("open"),X.setAttribute("aria-expanded",String(Q.classList.contains("open")))}),Q.addEventListener("click",e=>{const s=e.target.closest(".lang-option");if(!s)return;const o=s.dataset.locale;try{localStorage.setItem("locale",o)}catch{}window.location.reload()}),document.addEventListener("click",e=>{!X.contains(e.target)&&!Q.contains(e.target)&&Q.classList.remove("open")}));function j(e){if(!e)return"";try{return e.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase()}catch{return e.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}}function re(){try{J&&(J.value=""),D="",me=null,F=null,q=null;const e=document.getElementById("clear-composer");e&&(e.style.display="none");const s=document.getElementById("composer-content");s&&(s.innerHTML="Select a result to view composer details."),document.querySelectorAll("#filter-country input[type=checkbox], #filter-decade input[type=checkbox], #filter-type input[type=checkbox]").forEach(o=>o.checked=!1),C=1,T()}catch(e){console.error("clearAllFilters failed",e)}}function ee(){try{if(!q||!q.kind)return;const e=q.kind,s=q.value||"",o=e==="country"?"#filter-country input[type=checkbox]":e==="decade"?"#filter-decade input[type=checkbox]":"#filter-type input[type=checkbox]";document.querySelectorAll(o).forEach(n=>{try{decodeURIComponent(n.getAttribute("data-val")||n.dataset.val||"")===s&&(n.checked=!1)}catch{}}),q=null,C=1,T()}catch(e){console.error("clearLastAppliedFilter failed",e)}}function v(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}async function fe(e,s="A1:Z1000"){try{const n=`https://docs.google.com/spreadsheets/d/1UiK8QDq98C-9wCpQjdQAVpSdH8mZkpxYgMMEHM3uaGk/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(e)}&range=${encodeURIComponent(s)}`,g=(await(await fetch(n)).text()).match(/google\.visualization\.Query\.setResponse\((.*)\);?/s);if(!g||!g[1])return null;const y=JSON.parse(g[1]);if(!y||!y.table)return null;const i=(y.table.cols||[]).map(u=>u&&(u.label||u.id)?String(u.label||u.id):""),r=(y.table.rows||[]).map(u=>(u.c||[]).map(p=>p&&p.v!==void 0&&p.v!==null?p.v:""));return{cols:i,rows:r}}catch{return null}}const te=25;let C=1,_=[],D="",me=null,F=null,q=null,ae=null;const je=3e4;let G=null;async function $e(){const e=document.getElementById("filter-country");if(!e)return;const s=["Russia","Ukraine","Belarus","Armenia","Georgia","Latvia","Estonia","Lithuania","Kazakhstan","Uzbekistan","Other"];try{const n=await(await fetch("/i18n/translations.json")).json(),a=n&&n.en?n.en:null,g=a&&a.countries?a.countries:s,y=(function(){try{return localStorage.getItem("locale")||"en"}catch{return"en"}})(),i=n&&n[y]&&n[y].countries?n[y].countries:g;e.innerHTML="";for(let m=0;m<g.length;m++){const x=g[m],A=i&&i[m]?i[m]:x,d="country_cb_"+m,f=document.createElement("div");f.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(x)}" id="${d}" /> ${A}</label>`,e.appendChild(f)}const r=document.createElement("div");r.style.marginTop="8px",r.innerHTML='<button id="country-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="country-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(r),e.querySelectorAll("input[type=checkbox]").forEach(m=>m.addEventListener("change",x=>{try{q={kind:"country",value:decodeURIComponent(m.dataset.val||m.getAttribute("data-val")||"")}}catch{}D="",C=1,T()}));const u=document.getElementById("country-select-all"),p=document.getElementById("country-clear");u&&u.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(m=>m.checked=!0),C=1,T()}),p&&p.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(m=>m.checked=!1),C=1,T()})}catch{e.innerHTML=s.map((y,i)=>`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(y)}" id="country_cb_f${i}" /> ${y}</label>`).join("");const n=document.createElement("div");n.style.marginTop="8px",n.innerHTML='<button id="country-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="country-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(n),e.querySelectorAll("input[type=checkbox]").forEach(y=>y.addEventListener("change",i=>{try{q={kind:"decade",value:decodeURIComponent(y.dataset.val||y.getAttribute("data-val")||"")}}catch{}D="",C=1,T()}));const a=document.getElementById("country-select-all"),g=document.getElementById("country-clear");a&&a.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(y=>y.checked=!0),C=1,T()}),g&&g.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(y=>y.checked=!1),C=1,T()})}}async function Oe(){const e=document.getElementById("filter-decade");if(!e)return;const s=["1920s","1930s","1940s","1950s","1960s","1970s","1980s"];try{const n=await(await fetch("/i18n/translations.json")).json(),a=n&&n.en?n.en:null,g=a&&a.decades?a.decades:s,y=(function(){try{return localStorage.getItem("locale")||"en"}catch{return"en"}})(),i=n&&n[y]&&n[y].decades?n[y].decades:g;e.innerHTML="";const r=document.createElement("div");r.className="list-title",r.textContent="Decade",e.appendChild(r);for(let x=0;x<g.length;x++){const A=g[x],d=i&&i[x]?i[x]:A,f="decade_cb_"+x,l=document.createElement("div");l.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(A)}" id="${f}" /> ${d}</label>`,e.appendChild(l)}const u=document.createElement("div");u.style.marginTop="8px",u.innerHTML='<button id="decade-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="decade-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(u),e.querySelectorAll("input[type=checkbox]").forEach(x=>x.addEventListener("change",()=>{D="",C=1,T()}));const p=document.getElementById("decade-select-all"),m=document.getElementById("decade-clear");p&&p.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(x=>x.checked=!0),C=1,T()}),m&&m.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(x=>x.checked=!1),C=1,T()})}catch{e.innerHTML="";const n=document.createElement("div");n.className="list-title",n.textContent="Decade",e.appendChild(n),e.innerHTML+=s.map((g,y)=>`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(g)}" id="decade_cb_f${y}" /> ${g}</label>`).join("");const a=document.createElement("div");a.style.marginTop="8px",a.innerHTML='<button id="decade-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="decade-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(a),e.querySelectorAll("input[type=checkbox]").forEach(g=>g.addEventListener("change",()=>{C=1,T()}))}}async function Be(){const e=document.getElementById("filter-type");if(e){e.innerHTML="";try{const o=await(await fetch("/i18n/translations.json")).json(),n=o&&o.en?o.en:null,a=n&&n.types?n.types:null;if(a&&a.length){const d=o&&o[localStorage.getItem("locale")||"en"]&&o[localStorage.getItem("locale")||"en"].types?o[localStorage.getItem("locale")||"en"].types:a;e.innerHTML="";const f=document.createElement("div");f.className="list-title",f.textContent="Type of piece",e.appendChild(f),a.forEach((w,H)=>{const R=d&&d[H]?d[H]:w,$="type_cb_"+H,U=document.createElement("div");U.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(w)}" id="${$}" /> ${R}</label>`,e.appendChild(U)});const l=document.createElement("div");l.style.marginTop="8px",l.innerHTML='<button id="type-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="type-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(l),e.querySelectorAll("input[type=checkbox]").forEach(w=>w.addEventListener("change",H=>{try{q={kind:"type",value:decodeURIComponent(w.dataset.val||w.getAttribute("data-val")||"")}}catch{}C=1,T()}));const E=document.getElementById("type-select-all"),h=document.getElementById("type-clear");E&&E.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(w=>w.checked=!0),C=1,T()}),h&&h.addEventListener("click",()=>{q=null,e.querySelectorAll("input[type=checkbox]").forEach(w=>w.checked=!1),C=1,T()});return}const y=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null),i=Array.isArray(y)?y:y&&Array.isArray(y.rows)?y.rows:y,r=new Set;i.forEach(d=>{let f=d.Type||d.type||d["Type of piece"]||d.Type||"";f||(d.P!==void 0&&d.P!==null&&String(d.P).trim()!==""||d.P!==void 0&&d.P!==null&&String(d.P).trim()!==""?f=d.P:d.colP!==void 0&&d.colP!==null&&String(d.colP).trim()!==""&&(f=d.colP)),f||(f=d.Label||d.label||d["Piece Type"]||d["Type of Piece"]||""),f&&r.add(String(f).trim())});const u=Array.from(r).sort();e.innerHTML="";const p=document.createElement("div");p.className="list-title",p.textContent="Type of piece",e.appendChild(p);const m=document.createElement("div");m.style.marginTop="8px",m.innerHTML='<button id="type-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="type-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(m),u.forEach((d,f)=>{const l="type_cb_dyn_"+f,E=document.createElement("div");E.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(d)}" id="${l}" /> ${d}</label>`,e.appendChild(E)}),e.querySelectorAll("input[type=checkbox]").forEach(d=>d.addEventListener("change",()=>{C=1,T()}));const x=document.getElementById("type-select-all"),A=document.getElementById("type-clear");x&&x.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(d=>d.checked=!0),C=1,T()}),A&&A.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(d=>d.checked=!1),C=1,T()})}catch{e.innerHTML=""}}}function ne(e){const s=document.getElementById("results-list");s.innerHTML="";const o=(e-1)*te,n=_.slice(o,o+te);if(!n.length){s.innerHTML='<div class="result-item">No results</div>';return}n.forEach(a=>{const g=document.createElement("div");g.className="result-item";const y=a.Title||a.Compositions||"Untitled",i=a.Composer||a.Composer||"Unknown",r=a.Year||a.Published||a.Decade||"",u=v(i),p=encodeURIComponent(String(i)),m=_.indexOf(a);g.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;"><h2 style="margin:0"><a href="#" class="piece-link" data-idx="${m}">${v(y)}</a></h2><div class="result-right" data-idx="${m}" style="color:#6b7280;font-size:0.9rem;margin-left:12px;white-space:nowrap;cursor:pointer">Details</div></div><p><strong>Composer:</strong> <a href="#" class="composer-link" data-name="${p}">${u}</a></p><p><strong>Published:</strong> ${v(r)}</p>`,s.appendChild(g);const x=g.querySelector(".composer-link");x&&x.addEventListener("click",f=>{f.preventDefault();const l=decodeURIComponent(x.dataset.name||"");F=null,me=null,D=l||"",K(l,a),C=1,T()});try{x&&(x.style.color="var(--accent)",x.style.textDecoration="none",x.style.fontWeight="700");const f=g.querySelector(".piece-link");f&&(f.style.color="#000",f.style.textDecoration="none",f.style.fontWeight="700"),g.style.borderBottom="1px solid #d1d5db"}catch{}const A=g.querySelector(".piece-link");A&&A.addEventListener("click",f=>{f.preventDefault();const l=Number(A.dataset.idx);if(!Number.isFinite(l)||l<0||l>=_.length)return;const E=_[l],h=E.Composer||E.Composer||"";D=String(h||""),K(D,E),F=String(E.Title||E.Compositions||E.Title||E.Compositions||""),C=1,T()});const d=g.querySelector(".result-right");d&&d.addEventListener("click",f=>{try{f.preventDefault()}catch{}const l=Number(d.dataset.idx);if(!Number.isFinite(l)||l<0||l>=_.length)return;const E=_[l],h=E.Composer||E.Composer||"";D=String(h||""),K(D,E),F=String(E.Title||E.Compositions||E.Title||E.Compositions||""),C=1,T()});try{if(F&&String(F).length){const f=String(a.Title||a.Compositions||a.Title||a.Compositions||"").trim();if(f&&j(f)===j(F)){const l=(H,R)=>{if(!H)return null;const $=Object.keys(H||{}),U=String(R||"").toUpperCase();let N=$.find(O=>String(O||"").trim()===U);if(N)return N;const V=$.find(O=>String(O||"").toLowerCase().replace(/[^a-z0-9]/g,"")===("col"+U.toLowerCase()).replace(/[^a-z0-9]/g,""));if(V)return V;const B=$.find(O=>String(O||"").trim().toUpperCase()===U);if(B)return B;try{const O=U.charCodeAt(0)-65;if(O>=0&&O<$.length)return $[O]}catch{}return null},E=["J","K","L","M","N","O","P","Q","R"],h=document.createElement("div");h.className="piece-expanded",h.style.marginTop="10px",h.style.padding="10px",h.style.background="#fbfbfb",h.style.borderRadius="6px",h.style.border="1px solid #eee";const w=[];for(const H of E){let R=null,$="";if(Array.isArray(a))try{const N=H.charCodeAt(0)-65;N>=0&&N<a.length&&($=a[N]==null?"":String(a[N]))}catch{}else R=l(a,H),R&&($=a[R]==null?"":String(a[R]));if((!$||String($).trim()==="")&&!R){const N=Object.keys(a||{}).find(V=>/col\s*?\.?\d+|col[a-z]/i.test(String(V)));N&&($=a[N]==null?"":String(a[N]))}let U="";R&&String(R).trim()!==""?U=String(R).trim():U=H,$&&String($).trim()!==""&&w.push(`<div style="margin:4px 0"><strong style="color:var(--accent);display:inline-block;width:200px">${v(U)}</strong> ${v(String($))}</div>`)}h.innerHTML=w.length?w.join(`
`):'<div style="color:#6b7280">No additional columns J–R present for this row.</div>',g.appendChild(h)}}}catch{}}),Me(Math.ceil(_.length/te),e)}function Me(e,s){let o=document.getElementById("pagination");o&&o.remove();const n=document.getElementById("results-pagination-top");if(!document.getElementById("results")||!n)return;if(o=document.createElement("div"),o.id="pagination",o.className="pagination",e===1){n.innerHTML="";const f=document.createElement("div");f.style.display="flex",f.style.alignItems="center",f.style.gap="8px",f.style.justifyContent="flex-end";const l=document.createElement("div");l.style.color="#6b7280",l.style.paddingRight="6px",l.textContent="1 of 1",f.appendChild(l);const E=document.createElement("button");E.textContent="Clear all filters",E.style.padding="6px 10px",E.style.borderRadius="6px",E.style.border="1px solid #d1d5db",E.style.background="#fff",E.addEventListener("click",()=>{try{re()}catch{}}),f.appendChild(E);const h=document.createElement("button");h.textContent="Clear last filter",h.style.padding="6px 10px",h.style.borderRadius="6px",h.style.border="1px solid #d1d5db",h.style.background="#fff",h.addEventListener("click",()=>{try{typeof ee=="function"&&ee()}catch{}}),f.appendChild(h);const w=document.createElement("button");w.textContent="Live: Off",w.style.marginLeft="8px",w.style.padding="6px 10px",w.style.borderRadius="6px",w.addEventListener("click",()=>{G?(ue(),w.textContent="Live: Off"):(pe(),w.textContent="Live: On")}),f.appendChild(w),n.appendChild(f);return}o=document.createElement("div"),o.id="pagination",o.className="pagination";const g=document.createElement("button");g.textContent="Prev",g.disabled=s===1,g.addEventListener("click",()=>{C>1&&(C--,ne(C),window.scrollTo({top:0,behavior:"smooth"}))}),o.appendChild(g);const y=7,i=Math.floor(y/2);let r=Math.max(1,s-i),u=Math.min(e,r+y-1);u-r<y-1&&(r=Math.max(1,u-y+1));for(let f=r;f<=u;f++){const l=document.createElement("button");l.textContent=String(f),f===s&&l.classList.add("active"),l.addEventListener("click",()=>{C=f,ne(C),window.scrollTo({top:0,behavior:"smooth"})}),o.appendChild(l)}const p=document.createElement("button");p.textContent="Next",p.disabled=s>=e,p.addEventListener("click",()=>{C<e&&(C++,ne(C),window.scrollTo({top:0,behavior:"smooth"}))}),o.appendChild(p),n.innerHTML="";const m=document.createElement("div");m.style.display="flex",m.style.alignItems="center",m.style.gap="8px",m.style.justifyContent="flex-end";const x=document.createElement("button");x.textContent="Clear all filters",x.style.padding="6px 10px",x.style.borderRadius="6px",x.style.border="1px solid #d1d5db",x.style.background="#fff",x.addEventListener("click",()=>{try{re()}catch{}}),m.appendChild(x);const A=document.createElement("button");A.textContent="Clear last filter",A.style.padding="6px 10px",A.style.borderRadius="6px",A.style.border="1px solid #d1d5db",A.style.background="#fff",A.addEventListener("click",()=>{try{typeof ee=="function"&&ee()}catch{}}),m.appendChild(A);const d=document.createElement("button");d.textContent=G?"Live: On":"Live: Off",d.style.marginRight="8px",d.style.padding="6px 10px",d.style.borderRadius="6px",d.addEventListener("click",()=>{G?(ue(),d.textContent="Live: Off"):(pe(),d.textContent="Live: On")}),m.appendChild(d),m.appendChild(o),n.appendChild(m)}async function de(){try{const s=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null),o=Array.isArray(s)?s:s&&Array.isArray(s.rows)?s.rows:s,n=JSON.stringify(o);ae!==n&&(ae=n,T(o,{resetPage:!1}))}catch(e){console.error("poll failed",e)}}function pe(){G||(G=setInterval(de,je),de())}function ue(){G&&(clearInterval(G),G=null)}async function T(e,s={resetPage:!0}){try{let o=e;if(!o){const r=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null);o=Array.isArray(r)?r:r&&Array.isArray(r.rows)?r.rows:r}if(!Array.isArray(o))try{const i=await fe("MusicList");if(i&&i.rows&&i.rows.length){const r=i.cols.map((u,p)=>u&&String(u).trim()?String(u).trim():`col_${p}`);o=i.rows.map(u=>{const p={};for(let m=0;m<r.length;m++)p[r[m]]=u[m]!==void 0&&u[m]!==null?u[m]:"";return p})}else{const r=typeof o=="object"?JSON.stringify(o):String(o);document.getElementById("results").innerText="Load failed: unexpected /api/sheets response: "+r;return}}catch{const r=typeof o=="object"?JSON.stringify(o):String(o);document.getElementById("results").innerText="Load failed: unexpected /api/sheets response: "+r;return}const n=j(J.value||""),a=Array.from(document.querySelectorAll("#filter-country input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||"")),g=Array.from(document.querySelectorAll("#filter-decade input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||"")),y=Array.from(document.querySelectorAll("#filter-type input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||""));_=o.filter(i=>{if(n&&!j(Object.values(i||{}).join(" ")).includes(n))return!1;if(F&&F.length){const r=String(i.Title||i.Compositions||i.Title||i.Compositions||"").trim();if(!r||j(r)!==j(F))return!1}if(D){const r=(i.Composer||i.Composer||"").toString();if(!j(r).includes(j(D)))return!1}if(a.length){const r=j(i.Country||i.Nationality||"");if(!a.some(p=>j(p)&&r.includes(j(p))))return!1}if(g.length){const r=j(i.Decade||i.Year||"");if(!g.some(p=>j(p)&&r.includes(j(p))))return!1}if(y.length){const r=j(i.Type||i.type||i["Type of piece"]||i.Type||"");if(!y.some(p=>j(p)&&r.includes(j(p))))return!1}return!0}),s&&s.resetPage&&(C=1),ne(C);try{if(n&&n.length){let i=null;const r=Array.isArray(o)&&o.length?o:Array.isArray(_)?_:[];for(const u of r){const p=String(u.Composer||u.Composer||u.composer||"").trim();if(!p)continue;const m=j(p||"");if(m===n||m.includes(n)||n.includes(m)){i={name:p,row:u};break}}if(!i&&Array.isArray(_)&&_.length){const u=_[0],p=String(u.Composer||u.Composer||u.composer||"").trim();if(p){const m=j(p||"");(m.includes(n)||n.includes(m))&&(i={name:p,row:u})}}i&&(D=String(i.name||""),K(D,i.row))}}catch{}try{if(new URLSearchParams(window.location.search||"").get("random")==="1"&&_&&_.length){const r=(C-1)*te,u=_[r];if(u){const p=u.Composer||u.Composer||u.composer||Object.values(u)[0]||"";D=String(p||""),K(D,u)}}}catch{}}catch(o){document.getElementById("results").innerText="Load failed: "+String(o)}}async function K(e,s){const o=document.getElementById("composer-content"),n=document.getElementById("clear-composer");if(!o)return;if(!e){o.innerHTML="Select a result to view composer details.",n&&(n.style.display="none");return}const a=t=>String(t||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim(),g=t=>typeof j=="function"?j(String(t||"")):String(t||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim(),y=t=>{if(!t||typeof t!="object")return!1;const c=Object.keys(t).map(L=>a(L)),b=c.some(L=>L.includes("composer")||L.includes("композитор")),k=c.some(L=>L.includes("lifespan")||L.includes("life")||L.includes("born")||L.includes("died")||L.includes("years")),S=c.some(L=>L.includes("country")||L.includes("republic")||L.includes("nationality")||L.includes("soviet")),I=c.includes("title")||c.includes("compositions")||c.includes("snippet")||c.includes("published");return b&&(k||S)&&!I},i=["CompDet","Sheet2","ComposersAggregated","Composers","Aggregated"];let r=[],u=null;try{const c=await(await fetch("/api/sheets?sheet=MusicList",{headers:{Accept:"application/json"}})).json().catch(()=>null),b=c&&Array.isArray(c)?c:c&&c.rows&&Array.isArray(c.rows)?c.rows:null;b&&b.length&&(r=b,u="MusicList",console.debug("COMPOSER_DEBUG using MusicList aggregation (client-side)"))}catch{}for(const t of i)try{const b=await(await fetch("/api/sheets?sheet="+encodeURIComponent(t),{headers:{Accept:"application/json"}})).json().catch(()=>null),k=Array.isArray(b)?b:b&&Array.isArray(b.rows)?b.rows:b;if(Array.isArray(k)&&k.length){const S=k[0];if(y(S)){r=k,u=t,console.debug("COMPOSER_DEBUG selected sheet (api):",t,"headers:",Object.keys(S));break}else console.debug("COMPOSER_DEBUG rejected sheet (api):",t,"headers:",Object.keys(S))}else console.debug("COMPOSER_DEBUG no-array or empty from API for",t,k)}catch(c){console.debug("COMPOSER_DEBUG api fetch failed for",t,c)}if(!r||r.length===0)for(const t of i)try{const c=await fe(t);if(!c||!c.rows||!c.rows.length)continue;const b=c.cols.map(S=>String(S).trim()||""),k={};for(let S=0;S<b.length;S++){const I=b[S]||`col${S+1}`;k[I]=c.rows[0][S]}if(!y(k))continue;r=c.rows.map(S=>{const I={};for(let L=0;L<b.length;L++){const P=b[L]||`col${L+1}`;I[P]=S[L]!==void 0&&S[L]!==null?S[L]:""}return I}),u=t;break}catch(c){console.debug("COMPOSER_DEBUG gviz fetch failed for",t,c)}if(!r||r.length===0){o.innerHTML=`<div>No composer detail sheet (CompDet) could be located. I tried: ${i.join(", ")}.</div>`,n&&(n.style.display="none");return}let p=null,m=null;const x=String(e||"").trim(),A=g(x),d=Object.keys(r[0]||{}),f=d.find(t=>a(t).includes("composer")||a(t).includes("композитор"));if(f)for(const t of r){const c=String(t[f]||"").trim();if(!c)continue;const b=g(c);if(b===A||b.includes(A)||A.includes(b)){p=t,m=c;break}}if(!p)for(const t of r){for(const c of Object.values(t)){if(!c)continue;const b=String(c||"").trim(),k=g(b);if(k===A||k.includes(A)||A.includes(k)){p=t,m=b;break}}if(p)break}if(!p){const t=v(JSON.stringify(r[0]||{},null,2));o.innerHTML=`<div>No composer match in ${v(u||"CompDet")} for <strong>${v(e)}</strong>.</div>
      <div style="margin-top:8px;color:#6b7280;font-size:0.9rem">Sample headers from detected sheet (for debugging):</div>
      <pre style="max-height:220px;overflow:auto;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;font-size:0.85rem">${t}</pre>`,n&&(n.style.display="inline-block");return}let l={};if(Array.isArray(p)){const t=r&&r.length&&typeof r[0]=="object"?r[0]:null;if(t){const c=Object.keys(t);for(let b=0;b<p.length;b++)l[c[b]||`col${b+1}`]=p[b]}else for(let c=0;c<p.length;c++)l[`col${c+1}`]=p[c]}else typeof p=="object"&&p&&(l=p);if(s&&typeof s=="object"&&Object.keys(s).length){const t=M=>{for(const Y of M)if(s[Y]!==void 0&&s[Y]!==null&&String(s[Y]).trim()!=="")return String(s[Y]);return""},c=M=>{try{if(Array.isArray(s)&&s.length>M)return String(s[M])}catch{}return""},b=t(["A","colA","Composer","composer","Name","name"])||c(0)||"",k=t(["B","colB","Lifespan","lifespan"])||c(1)||"",S=t(["C","colC","Russian","russian"])||c(2)||"",I=Object.keys(s).find(M=>String(M).trim().toUpperCase()==="C")||"Russian",L=Object.keys(s).find(M=>String(M).trim().toUpperCase()==="D")||"D";let P="";try{d&&d[3]&&l&&l.hasOwnProperty(d[3])&&(P=String(l[d[3]]||"")),P||(P=t([L,"D","colD","Label","label"])||L||"D")}catch{P=t([L,"D","colD","Label","label"])||L}const Z=t(["E","colE","Value","value"])||c(4)||"",oe=t(["F","colF","Country","country","Nationality"])||c(5)||"",ie=t(["G","colG","Soviet republic","republic"])||c(6)||"",z=t(["H","colH","Gender","gender"])||c(7)||"",W=t(["I","colI","Notes","notes"])||c(8)||"";o.innerHTML=`
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><h1 style="margin:0 0 6px 0; font-size:1.25rem">${v(b)}</h1><span class="spinner" aria-hidden="true" title="Loading more details"></span></div>
        ${k?`<p style="margin:0 0 8px 0"><i>${v(k)}</i></p>`:""}
        <br/>
        <p style="margin:6px 0"><b>${v(I)}:</b> ${v(S)}</p>
        <p style="margin:6px 0"><b>${v(P)}:</b> ${v(Z)}</p>
        <br/>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(M=>String(M).trim().toUpperCase()==="F")||"Country")}:</b> ${v(oe)}</p>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(M=>String(M).trim().toUpperCase()==="G")||"Soviet Republic")}:</b> ${v(ie)}</p>
        <br/>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(M=>String(M).trim().toUpperCase()==="H")||"Gender")}:</b> ${v(z)}</p>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(M=>String(M).trim().toUpperCase()==="I")||"Notes")}:</b> ${v(W)}</p>
      </div>
    `,n&&(n.style.display="inline-block")}const E=["Composer","Lifespan","Country","Soviet republic","Nationality","Language","Notes","Learn more"],h={};if(Object.keys(l||{}).forEach(t=>{try{h[a(t)]=l[t]}catch{h[String(t||"")]=l[t]}}),u==="MusicList"){const t=(oe,ie=[])=>{for(const z of oe)if(l.hasOwnProperty(z)&&l[z]!==void 0&&l[z]!==null&&String(l[z]).trim()!=="")return String(l[z]);for(const z of ie)for(const W of Object.keys(l))if(String(W||"").toLowerCase().trim()===z.toLowerCase().trim()&&l[W])return String(l[W]);return""},c=t(["A","colA","Composer","composer","name"]),b=t(["B","colN","Lifespan","lifespan","Years"]),k=t(["C","colB","Russian","russian"]),S=t(["D","P","Label","label"]),I=t(["E","C","Value","native"]),L=t(["F","K","Country","country"]),P=t(["G","O","Soviet republic","republic"]),Z=t(["I","Q","Notes","notes"]);c&&(h.composer=c),b&&(h.lifespan=b),k&&(h.russian=k),S&&I&&(h[a(S)]=I),L&&(h.country=L),P&&(h["soviet republic"]=P),Z&&(h.notes=Z)}const w=t=>{for(const k of t){const S=a(k);if(S&&S in h&&h[S]!==void 0&&h[S]!==null&&String(h[S]).trim()!=="")return String(h[S])}const c=Object.values(h||{}).map(k=>k==null?"":String(k)),b=/\b\d{3,4}\s*[–—-]\s*\d{2,4}\b|\b\d{3,4}\b/;for(const k of c)if(k&&b.test(String(k)))return k;for(const k of c)if(k&&String(k).trim()!=="")return k;return""},H={Composer:["Composer","Композитор","composer","Name","name"],Lifespan:["Lifespan","Life span","Born","Died","Years"],Country:["Country","country","Страна","Country of birth","Nationality"],"Soviet republic":["Soviet republic","Republic","Soviet"],Nationality:["Nationality","Nationality (EN)"],Language:["Language","language","Язык"],Notes:["Notes","notes","Примечания"],"Learn more":["Learn more","Link","URL"]},R=E.map(t=>{const c=H[t]||[t],b=w(c);return b==null?"":String(b)}),$=E.indexOf("Lifespan"),U=$>=0&&R[$]||""||"",N=t=>String(t||"").replace(/[\r\n\t]+/g," ").replace(/\s+/g," ").trim();N(m);const V=N(U);u&&`${v(u)}`,V&&`${v(V)}`;const B=t=>{if(!t)return null;const c=String(t).trim().toLowerCase(),b=Object.keys(l).find(I=>String(I||"").trim().toLowerCase()===c);if(b)return b;const k=Object.keys(l).find(I=>String(I||"").toLowerCase().replace(/[^a-z0-9]/g,"")===("col"+c).replace(/[^a-z0-9]/g,""));if(k)return k;const S=Object.keys(l).find(I=>String(I||"").trim()===String(t).toUpperCase());if(S)return S;try{const I=String(t).toUpperCase().charCodeAt(0)-65;if(typeof d<"u"&&Array.isArray(d)&&I>=0&&I<d.length)return d[I]}catch{}return null},O=t=>{if(!t)return"";const c=l[t];return c==null?"":String(c)},ye=O(B("A")),ce=O(B("B")),ge=O(B("C")),le=B("D"),be=le?String(le):"D",he=O(B("E")),xe=O(B("F")),ve=O(B("G")),ke=O(B("H")),Ce=O(B("I")),Ee=B("C")||"Russian";let se=be;try{l&&Object.keys(l)[3]&&l[Object.keys(l)[3]]&&(se=String(l[Object.keys(l)[3]]))}catch{}const Se=B("F")||"Country",Le=B("G")||"Soviet Republic",Ae=B("H")||"Gender",we=B("I")||"Notes";o.innerHTML=`
    <div>
      <h1 style="margin:0 0 6px 0; font-size:1.25rem">${v(ye)}</h1>
      ${ce?`<p style="margin:0 0 8px 0"><i>${v(ce)}</i></p>`:""}
  <br/>
  <p style="margin:6px 0"><b>${v(Ee)}:</b> ${v(ge)}</p>
  <p style="margin:6px 0"><b>${v(se)}:</b> ${v(he)}</p>
  <br/>
  <p style="margin:6px 0"><b>${v(Se)}:</b> ${v(xe)}</p>
  <p style="margin:6px 0"><b>${v(Le)}:</b> ${v(ve)}</p>
  <br/>
  <p style="margin:6px 0"><b>${v(Ae)}:</b> ${v(ke)}</p>
  <p style="margin:6px 0"><b>${v(we)}:</b> ${v(Ce)}</p>
    </div>
    `,n&&(n.style.display="inline-block",n.onclick=()=>{D="",n&&(n.style.display="none"),K("",null),C=1,T()})}(async function(){try{const s=document.getElementById("results-list");s&&(s.innerHTML='<div class="result-item"><em>Loading results…</em></div>');const o=document.getElementById("filter-country");o&&(o.innerHTML='<div style="color:#6b7280">Loading…</div>');const n=document.getElementById("filter-decade");n&&(n.innerHTML='<div style="color:#6b7280">Loading…</div>');const a=document.getElementById("filter-type");a&&(a.innerHTML='<div style="color:#6b7280">Loading…</div>'),await Promise.allSettled([$e(),Oe(),Be()]);const g=document.getElementById("qbtn");g&&g.addEventListener("click",()=>{C=1,T()}),J&&J.addEventListener("keydown",y=>{y.key==="Enter"&&(C=1,T())});try{const y=document.getElementById("clear-all-filters-btn");y&&y.addEventListener("click",()=>{re()})}catch{}try{K("",null)}catch{}await T()}catch(s){const o=document.getElementById("results");o&&(o.innerText="Initialization failed: "+String(s)),console.error("Initialization failed",s)}})();
