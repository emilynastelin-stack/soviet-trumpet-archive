const Te=new URLSearchParams(window.location.search),Ie=Te.get("q")||"",J=document.getElementById("qinput");J.placeholder="Search composers, countries, or pieces...";J.value=decodeURIComponent(Ie);const X=document.getElementById("langBtn"),Q=document.getElementById("langDropdown");X&&Q&&(X.addEventListener("click",()=>{Q.classList.toggle("open"),X.setAttribute("aria-expanded",String(Q.classList.contains("open")))}),Q.addEventListener("click",e=>{const s=e.target.closest(".lang-option");if(!s)return;const o=s.dataset.locale;try{localStorage.setItem("locale",o)}catch{}window.location.reload()}),document.addEventListener("click",e=>{!X.contains(e.target)&&!Q.contains(e.target)&&Q.classList.remove("open")}));function j(e){if(!e)return"";try{return e.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase()}catch{return e.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}}function ce(){try{J&&(J.value=""),N="",ye=null,F=null,D=null;const e=document.getElementById("clear-composer");e&&(e.style.display="none");const s=document.getElementById("composer-content");s&&(s.innerHTML="Select a result to view composer details."),document.querySelectorAll("#filter-country input[type=checkbox], #filter-decade input[type=checkbox], #filter-type input[type=checkbox]").forEach(o=>o.checked=!1),C=1,T()}catch(e){console.error("clearAllFilters failed",e)}}function ee(){try{if(!D||!D.kind)return;const e=D.kind,s=D.value||"",o=e==="country"?"#filter-country input[type=checkbox]":e==="decade"?"#filter-decade input[type=checkbox]":"#filter-type input[type=checkbox]";document.querySelectorAll(o).forEach(t=>{try{decodeURIComponent(t.getAttribute("data-val")||t.dataset.val||"")===s&&(t.checked=!1)}catch{}}),D=null,C=1,T()}catch(e){console.error("clearLastAppliedFilter failed",e)}}function v(e){return e==null?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}async function fe(e,s="A1:Z1000"){try{const t=`https://docs.google.com/spreadsheets/d/1UiK8QDq98C-9wCpQjdQAVpSdH8mZkpxYgMMEHM3uaGk/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(e)}&range=${encodeURIComponent(s)}`,g=(await(await fetch(t)).text()).match(/google\.visualization\.Query\.setResponse\((.*)\);?/s);if(!g||!g[1])return null;const m=JSON.parse(g[1]);if(!m||!m.table)return null;const i=(m.table.cols||[]).map(u=>u&&(u.label||u.id)?String(u.label||u.id):""),c=(m.table.rows||[]).map(u=>(u.c||[]).map(p=>p&&p.v!==void 0&&p.v!==null?p.v:""));return{cols:i,rows:c}}catch{return null}}const te=25;let C=1,_=[],N="",ye=null,F=null,D=null,ae=null;const je=3e4;let G=null;async function $e(){const e=document.getElementById("filter-country");if(!e)return;const s=["Russia","Ukraine","Belarus","Armenia","Georgia","Latvia","Estonia","Lithuania","Kazakhstan","Uzbekistan","Other"];try{const t=await(await fetch("/i18n/translations.json")).json(),a=t&&t.en?t.en:null,g=a&&a.countries?a.countries:s,m=(function(){try{return localStorage.getItem("locale")||"en"}catch{return"en"}})(),i=t&&t[m]&&t[m].countries?t[m].countries:g;e.innerHTML="";for(let y=0;y<g.length;y++){const x=g[y],A=i&&i[y]?i[y]:x,d="country_cb_"+y,f=document.createElement("div");f.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(x)}" id="${d}" /> ${A}</label>`,e.appendChild(f)}const c=document.createElement("div");c.style.marginTop="8px",c.innerHTML='<button id="country-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="country-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(c),e.querySelectorAll("input[type=checkbox]").forEach(y=>y.addEventListener("change",x=>{try{D={kind:"country",value:decodeURIComponent(y.dataset.val||y.getAttribute("data-val")||"")}}catch{}N="",C=1,T()}));const u=document.getElementById("country-select-all"),p=document.getElementById("country-clear");u&&u.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(y=>y.checked=!0),C=1,T()}),p&&p.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(y=>y.checked=!1),C=1,T()})}catch{e.innerHTML=s.map((m,i)=>`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(m)}" id="country_cb_f${i}" /> ${m}</label>`).join("");const t=document.createElement("div");t.style.marginTop="8px",t.innerHTML='<button id="country-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="country-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(t),e.querySelectorAll("input[type=checkbox]").forEach(m=>m.addEventListener("change",i=>{try{D={kind:"decade",value:decodeURIComponent(m.dataset.val||m.getAttribute("data-val")||"")}}catch{}N="",C=1,T()}));const a=document.getElementById("country-select-all"),g=document.getElementById("country-clear");a&&a.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(m=>m.checked=!0),C=1,T()}),g&&g.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(m=>m.checked=!1),C=1,T()})}}async function Be(){const e=document.getElementById("filter-decade");if(!e)return;const s=["1920s","1930s","1940s","1950s","1960s","1970s","1980s"];try{const t=await(await fetch("/i18n/translations.json")).json(),a=t&&t.en?t.en:null,g=a&&a.decades?a.decades:s,m=(function(){try{return localStorage.getItem("locale")||"en"}catch{return"en"}})(),i=t&&t[m]&&t[m].decades?t[m].decades:g;e.innerHTML="";const c=document.createElement("div");c.className="list-title",c.textContent="Decade",e.appendChild(c);for(let x=0;x<g.length;x++){const A=g[x],d=i&&i[x]?i[x]:A,f="decade_cb_"+x,r=document.createElement("div");r.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(A)}" id="${f}" /> ${d}</label>`,e.appendChild(r)}const u=document.createElement("div");u.style.marginTop="8px",u.innerHTML='<button id="decade-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="decade-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(u),e.querySelectorAll("input[type=checkbox]").forEach(x=>x.addEventListener("change",()=>{N="",C=1,T()}));const p=document.getElementById("decade-select-all"),y=document.getElementById("decade-clear");p&&p.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(x=>x.checked=!0),C=1,T()}),y&&y.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(x=>x.checked=!1),C=1,T()})}catch{e.innerHTML="";const t=document.createElement("div");t.className="list-title",t.textContent="Decade",e.appendChild(t),e.innerHTML+=s.map((g,m)=>`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(g)}" id="decade_cb_f${m}" /> ${g}</label>`).join("");const a=document.createElement("div");a.style.marginTop="8px",a.innerHTML='<button id="decade-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="decade-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(a),e.querySelectorAll("input[type=checkbox]").forEach(g=>g.addEventListener("change",()=>{C=1,T()}))}}async function Me(){const e=document.getElementById("filter-type");if(e){e.innerHTML="";try{const o=await(await fetch("/i18n/translations.json")).json(),t=o&&o.en?o.en:null,a=t&&t.types?t.types:null;if(a&&a.length){const d=o&&o[localStorage.getItem("locale")||"en"]&&o[localStorage.getItem("locale")||"en"].types?o[localStorage.getItem("locale")||"en"].types:a;e.innerHTML="";const f=document.createElement("div");f.className="list-title",f.textContent="Type of piece",e.appendChild(f),a.forEach((w,O)=>{const H=d&&d[O]?d[O]:w,$="type_cb_"+O,U=document.createElement("div");U.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(w)}" id="${$}" /> ${H}</label>`,e.appendChild(U)});const r=document.createElement("div");r.style.marginTop="8px",r.innerHTML='<button id="type-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="type-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(r),e.querySelectorAll("input[type=checkbox]").forEach(w=>w.addEventListener("change",O=>{try{D={kind:"type",value:decodeURIComponent(w.dataset.val||w.getAttribute("data-val")||"")}}catch{}C=1,T()}));const L=document.getElementById("type-select-all"),h=document.getElementById("type-clear");L&&L.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(w=>w.checked=!0),C=1,T()}),h&&h.addEventListener("click",()=>{D=null,e.querySelectorAll("input[type=checkbox]").forEach(w=>w.checked=!1),C=1,T()});return}const m=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null),i=Array.isArray(m)?m:m&&Array.isArray(m.rows)?m.rows:m,c=new Set;i.forEach(d=>{let f=d.Type||d.type||d["Type of piece"]||d.Type||"";f||(d.P!==void 0&&d.P!==null&&String(d.P).trim()!==""||d.P!==void 0&&d.P!==null&&String(d.P).trim()!==""?f=d.P:d.colP!==void 0&&d.colP!==null&&String(d.colP).trim()!==""&&(f=d.colP)),f||(f=d.Label||d.label||d["Piece Type"]||d["Type of Piece"]||""),f&&c.add(String(f).trim())});const u=Array.from(c).sort();e.innerHTML="";const p=document.createElement("div");p.className="list-title",p.textContent="Type of piece",e.appendChild(p);const y=document.createElement("div");y.style.marginTop="8px",y.innerHTML='<button id="type-select-all" style="margin-right:6px;padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Select All</button><button id="type-clear" style="padding:4px 8px;border-radius:6px;border:1px solid #d1d5db;background:#fff;">Clear</button>',e.appendChild(y),u.forEach((d,f)=>{const r="type_cb_dyn_"+f,L=document.createElement("div");L.innerHTML=`<label style="display:block;margin-bottom:6px;"><input type="checkbox" data-val="${encodeURIComponent(d)}" id="${r}" /> ${d}</label>`,e.appendChild(L)}),e.querySelectorAll("input[type=checkbox]").forEach(d=>d.addEventListener("change",()=>{C=1,T()}));const x=document.getElementById("type-select-all"),A=document.getElementById("type-clear");x&&x.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(d=>d.checked=!0),C=1,T()}),A&&A.addEventListener("click",()=>{e.querySelectorAll("input[type=checkbox]").forEach(d=>d.checked=!1),C=1,T()})}catch{e.innerHTML=""}}}function ne(e){const s=document.getElementById("results-list");s.innerHTML="";const o=(e-1)*te,t=_.slice(o,o+te);if(!t.length){s.innerHTML='<div class="result-item">No results</div>';return}t.forEach(a=>{const g=document.createElement("div");g.className="result-item";const m=a.Title||a.Compositions||"Untitled",i=a.Composer||a.Composer||"Unknown",c=a.Year||a.Published||a.Decade||"",u=v(i),p=encodeURIComponent(String(i)),y=_.indexOf(a);g.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;"><h2 style="margin:0"><a href="#" class="piece-link" data-idx="${y}">${v(m)}</a></h2><div class="result-right" data-idx="${y}" style="color:#6b7280;font-size:0.9rem;margin-left:12px;white-space:nowrap;cursor:pointer">Details</div></div><p><strong>Composer:</strong> <a href="#" class="composer-link" data-name="${p}">${u}</a></p><p><strong>Published:</strong> ${v(c)}</p>`,s.appendChild(g);const x=g.querySelector(".composer-link");x&&x.addEventListener("click",f=>{f.preventDefault();const r=decodeURIComponent(x.dataset.name||"");F=null,ye=null,N=r||"",K(r,a),C=1,T()});try{x&&(x.style.color="var(--accent)",x.style.textDecoration="none",x.style.fontWeight="700");const f=g.querySelector(".piece-link");f&&(f.style.color="#000",f.style.textDecoration="none",f.style.fontWeight="700"),g.style.borderBottom="1px solid #d1d5db"}catch{}const A=g.querySelector(".piece-link");A&&A.addEventListener("click",f=>{f.preventDefault();const r=Number(A.dataset.idx);if(!Number.isFinite(r)||r<0||r>=_.length)return;const L=_[r],h=L.Composer||L.Composer||"";N=String(h||""),K(N,L),F=String(L.Title||L.Compositions||L.Title||L.Compositions||""),C=1,T()});const d=g.querySelector(".result-right");d&&d.addEventListener("click",f=>{try{f.preventDefault()}catch{}const r=Number(d.dataset.idx);if(!Number.isFinite(r)||r<0||r>=_.length)return;const L=_[r],h=L.Composer||L.Composer||"";N=String(h||""),K(N,L),F=String(L.Title||L.Compositions||L.Title||L.Compositions||""),C=1,T()});try{if(F&&String(F).length){const f=String(a.Title||a.Compositions||a.Title||a.Compositions||"").trim();if(f&&j(f)===j(F)){const r=(O,H)=>{if(!O)return null;const $=Object.keys(O||{}),U=String(H||"").toUpperCase();let q=$.find(B=>String(B||"").trim()===U);if(q)return q;const V=$.find(B=>String(B||"").toLowerCase().replace(/[^a-z0-9]/g,"")===("col"+U.toLowerCase()).replace(/[^a-z0-9]/g,""));if(V)return V;const M=$.find(B=>String(B||"").trim().toUpperCase()===U);if(M)return M;try{const B=U.charCodeAt(0)-65;if(B>=0&&B<$.length)return $[B]}catch{}return null},L=["J","K","L","M","N","O","P","Q","R"],h=document.createElement("div");h.className="piece-expanded",h.style.marginTop="10px",h.style.padding="10px",h.style.background="#fbfbfb",h.style.borderRadius="6px",h.style.border="1px solid #eee";const w=[];for(const O of L){let H=null,$="";if(Array.isArray(a))try{const q=O.charCodeAt(0)-65;q>=0&&q<a.length&&($=a[q]==null?"":String(a[q]))}catch{}else H=r(a,O),H&&($=a[H]==null?"":String(a[H]));if((!$||String($).trim()==="")&&!H){const q=Object.keys(a||{}).find(V=>/col\s*?\.?\d+|col[a-z]/i.test(String(V)));q&&($=a[q]==null?"":String(a[q]))}let U="";H&&String(H).trim()!==""?U=String(H).trim():U=O,$&&String($).trim()!==""&&w.push(`<div style="margin:4px 0"><strong style="color:var(--accent);display:inline-block;width:200px">${v(U)}</strong> ${v(String($))}</div>`)}h.innerHTML=w.length?w.join(`
`):'<div style="color:#6b7280">No additional columns J–R present for this row.</div>',g.appendChild(h)}}}catch{}}),Re(Math.ceil(_.length/te),e)}function Re(e,s){let o=document.getElementById("pagination");o&&o.remove();const t=document.getElementById("results-pagination-top");if(!document.getElementById("results")||!t)return;if(o=document.createElement("div"),o.id="pagination",o.className="pagination",e===1){t.innerHTML="";const f=document.createElement("div");f.style.display="flex",f.style.alignItems="center",f.style.gap="8px",f.style.justifyContent="flex-end";const r=document.createElement("div");r.style.color="#6b7280",r.style.paddingRight="6px",r.textContent="1 of 1",f.appendChild(r);const L=document.createElement("button");L.textContent="Clear all filters",L.style.padding="6px 10px",L.style.borderRadius="6px",L.style.border="1px solid #d1d5db",L.style.background="#fff",L.addEventListener("click",()=>{try{ce()}catch{}}),f.appendChild(L);const h=document.createElement("button");h.textContent="Clear last filter",h.style.padding="6px 10px",h.style.borderRadius="6px",h.style.border="1px solid #d1d5db",h.style.background="#fff",h.addEventListener("click",()=>{try{typeof ee=="function"&&ee()}catch{}}),f.appendChild(h);const w=document.createElement("button");w.textContent="Live: Off",w.style.marginLeft="8px",w.style.padding="6px 10px",w.style.borderRadius="6px",w.addEventListener("click",()=>{G?(ue(),w.textContent="Live: Off"):(pe(),w.textContent="Live: On")}),f.appendChild(w),t.appendChild(f);return}o=document.createElement("div"),o.id="pagination",o.className="pagination";const g=document.createElement("button");g.textContent="Prev",g.disabled=s===1,g.addEventListener("click",()=>{C>1&&(C--,ne(C),window.scrollTo({top:0,behavior:"smooth"}))}),o.appendChild(g);const m=7,i=Math.floor(m/2);let c=Math.max(1,s-i),u=Math.min(e,c+m-1);u-c<m-1&&(c=Math.max(1,u-m+1));for(let f=c;f<=u;f++){const r=document.createElement("button");r.textContent=String(f),f===s&&r.classList.add("active"),r.addEventListener("click",()=>{C=f,ne(C),window.scrollTo({top:0,behavior:"smooth"})}),o.appendChild(r)}const p=document.createElement("button");p.textContent="Next",p.disabled=s>=e,p.addEventListener("click",()=>{C<e&&(C++,ne(C),window.scrollTo({top:0,behavior:"smooth"}))}),o.appendChild(p),t.innerHTML="";const y=document.createElement("div");y.style.display="flex",y.style.alignItems="center",y.style.gap="8px",y.style.justifyContent="flex-end";const x=document.createElement("button");x.textContent="Clear all filters",x.style.padding="6px 10px",x.style.borderRadius="6px",x.style.border="1px solid #d1d5db",x.style.background="#fff",x.addEventListener("click",()=>{try{ce()}catch{}}),y.appendChild(x);const A=document.createElement("button");A.textContent="Clear last filter",A.style.padding="6px 10px",A.style.borderRadius="6px",A.style.border="1px solid #d1d5db",A.style.background="#fff",A.addEventListener("click",()=>{try{typeof ee=="function"&&ee()}catch{}}),y.appendChild(A);const d=document.createElement("button");d.textContent=G?"Live: On":"Live: Off",d.style.marginRight="8px",d.style.padding="6px 10px",d.style.borderRadius="6px",d.addEventListener("click",()=>{G?(ue(),d.textContent="Live: Off"):(pe(),d.textContent="Live: On")}),y.appendChild(d),y.appendChild(o),t.appendChild(y)}async function de(){try{const s=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null),o=Array.isArray(s)?s:s&&Array.isArray(s.rows)?s.rows:s,t=JSON.stringify(o);ae!==t&&(ae=t,T(o,{resetPage:!1}))}catch(e){console.error("poll failed",e)}}function pe(){G||(G=setInterval(de,je),de())}function ue(){G&&(clearInterval(G),G=null)}async function T(e,s={resetPage:!0}){try{let o=e;if(!o){const c=await(await fetch("/api/sheets",{headers:{Accept:"application/json"}})).json().catch(()=>null);o=Array.isArray(c)?c:c&&Array.isArray(c.rows)?c.rows:c}if(!Array.isArray(o))try{const i=await fe("MusicList");if(i&&i.rows&&i.rows.length){const c=i.cols.map((u,p)=>u&&String(u).trim()?String(u).trim():`col_${p}`);o=i.rows.map(u=>{const p={};for(let y=0;y<c.length;y++)p[c[y]]=u[y]!==void 0&&u[y]!==null?u[y]:"";return p})}else{const c=typeof o=="object"?JSON.stringify(o):String(o);document.getElementById("results").innerText="Load failed: unexpected /api/sheets response: "+c;return}}catch{const c=typeof o=="object"?JSON.stringify(o):String(o);document.getElementById("results").innerText="Load failed: unexpected /api/sheets response: "+c;return}const t=j(J.value||""),a=Array.from(document.querySelectorAll("#filter-country input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||"")),g=Array.from(document.querySelectorAll("#filter-decade input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||"")),m=Array.from(document.querySelectorAll("#filter-type input[type=checkbox]:checked")).map(i=>decodeURIComponent(i.dataset.val||i.getAttribute("data-val")||""));_=o.filter(i=>{if(t&&!j(Object.values(i||{}).join(" ")).includes(t))return!1;if(F&&F.length){const c=String(i.Title||i.Compositions||i.Title||i.Compositions||"").trim();if(!c||j(c)!==j(F))return!1}if(N){const c=(i.Composer||i.Composer||"").toString();if(!j(c).includes(j(N)))return!1}if(a.length){const c=j(i.Country||i.Nationality||"");if(!a.some(p=>j(p)&&c.includes(j(p))))return!1}if(g.length){const c=j(i.Decade||i.Year||"");if(!g.some(p=>j(p)&&c.includes(j(p))))return!1}if(m.length){const c=j(i.Type||i.type||i["Type of piece"]||i.Type||"");if(!m.some(p=>j(p)&&c.includes(j(p))))return!1}return!0}),s&&s.resetPage&&(C=1),ne(C);try{if(t&&t.length){let i=null;const c=Array.isArray(o)&&o.length?o:Array.isArray(_)?_:[];for(const u of c){const p=String(u.Composer||u.Composer||u.composer||"").trim();if(!p)continue;const y=j(p||"");if(y===t||y.includes(t)||t.includes(y)){i={name:p,row:u};break}}if(!i&&Array.isArray(_)&&_.length){const u=_[0],p=String(u.Composer||u.Composer||u.composer||"").trim();if(p){const y=j(p||"");(y.includes(t)||t.includes(y))&&(i={name:p,row:u})}}i&&(N=String(i.name||""),K(N,i.row))}}catch{}try{if(new URLSearchParams(window.location.search||"").get("random")==="1"&&_&&_.length){const c=(C-1)*te,u=_[c];if(u){const p=u.Composer||u.Composer||u.composer||Object.values(u)[0]||"";N=String(p||""),K(N,u)}}}catch{}}catch(o){document.getElementById("results").innerText="Load failed: "+String(o)}}async function K(e,s){const o=document.getElementById("composer-content"),t=document.getElementById("clear-composer");if(!o)return;if(!e){o.innerHTML="Select a result to view composer details.",t&&(t.style.display="none");return}const a=n=>String(n||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim(),g=n=>typeof j=="function"?j(String(n||"")):String(n||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim(),m=n=>{if(!n||typeof n!="object")return!1;const l=Object.keys(n).map(S=>a(S)),b=l.some(S=>S.includes("composer")||S.includes("композитор")),k=l.some(S=>S.includes("lifespan")||S.includes("life")||S.includes("born")||S.includes("died")||S.includes("years")),E=l.some(S=>S.includes("country")||S.includes("republic")||S.includes("nationality")||S.includes("soviet")),I=l.includes("title")||l.includes("compositions")||l.includes("snippet")||l.includes("published");return b&&(k||E)&&!I},i=["CompDet","Sheet2","ComposersAggregated","Composers","Aggregated"];let c=[],u=null;try{const l=await(await fetch("/api/sheets?sheet=MusicList",{headers:{Accept:"application/json"}})).json().catch(()=>null),b=l&&Array.isArray(l)?l:l&&l.rows&&Array.isArray(l.rows)?l.rows:null;b&&b.length&&(c=b,u="MusicList")}catch{}for(const n of i)try{const b=await(await fetch("/api/sheets?sheet="+encodeURIComponent(n),{headers:{Accept:"application/json"}})).json().catch(()=>null),k=Array.isArray(b)?b:b&&Array.isArray(b.rows)?b.rows:b;if(Array.isArray(k)&&k.length){const E=k[0];if(m(E)){c=k,u=n;break}}}catch{}if(!c||c.length===0)for(const n of i)try{const l=await fe(n);if(!l||!l.rows||!l.rows.length)continue;const b=l.cols.map(E=>String(E).trim()||""),k={};for(let E=0;E<b.length;E++){const I=b[E]||`col${E+1}`;k[I]=l.rows[0][E]}if(!m(k))continue;c=l.rows.map(E=>{const I={};for(let S=0;S<b.length;S++){const P=b[S]||`col${S+1}`;I[P]=E[S]!==void 0&&E[S]!==null?E[S]:""}return I}),u=n;break}catch{}if(!c||c.length===0){o.innerHTML=`<div>No composer detail sheet (CompDet) could be located. I tried: ${i.join(", ")}.</div>`,t&&(t.style.display="none");return}let p=null,y=null;const x=String(e||"").trim(),A=g(x),d=Object.keys(c[0]||{}),f=d.find(n=>a(n).includes("composer")||a(n).includes("композитор"));if(f)for(const n of c){const l=String(n[f]||"").trim();if(!l)continue;const b=g(l);if(b===A||b.includes(A)||A.includes(b)){p=n,y=l;break}}if(!p)for(const n of c){for(const l of Object.values(n)){if(!l)continue;const b=String(l||"").trim(),k=g(b);if(k===A||k.includes(A)||A.includes(k)){p=n,y=b;break}}if(p)break}if(!p){o.innerHTML=`<div>No composer match was found in the detected detail sheet for <strong>${v(e)}</strong>. Try adjusting the search or check the spelling.</div>`,t&&(t.style.display="inline-block");return}let r={};if(Array.isArray(p)){const n=c&&c.length&&typeof c[0]=="object"?c[0]:null;if(n){const l=Object.keys(n);for(let b=0;b<p.length;b++)r[l[b]||`col${b+1}`]=p[b]}else for(let l=0;l<p.length;l++)r[`col${l+1}`]=p[l]}else typeof p=="object"&&p&&(r=p);if(s&&typeof s=="object"&&Object.keys(s).length){const n=R=>{for(const Y of R)if(s[Y]!==void 0&&s[Y]!==null&&String(s[Y]).trim()!=="")return String(s[Y]);return""},l=R=>{try{if(Array.isArray(s)&&s.length>R)return String(s[R])}catch{}return""},b=n(["A","colA","Composer","composer","Name","name"])||l(0)||"",k=n(["B","colB","Lifespan","lifespan"])||l(1)||"",E=n(["C","colC","Russian","russian"])||l(2)||"",I=Object.keys(s).find(R=>String(R).trim().toUpperCase()==="C")||"Russian",S=Object.keys(s).find(R=>String(R).trim().toUpperCase()==="D")||"D";let P="";try{d&&d[3]&&r&&r.hasOwnProperty(d[3])&&(P=String(r[d[3]]||"")),P||(P=n([S,"D","colD","Label","label"])||S||"D")}catch{P=n([S,"D","colD","Label","label"])||S}const Z=n(["E","colE","Value","value"])||l(4)||"",oe=n(["F","colF","Country","country","Nationality"])||l(5)||"",ie=n(["G","colG","Soviet republic","republic"])||l(6)||"",z=n(["H","colH","Gender","gender"])||l(7)||"",W=n(["I","colI","Notes","notes"])||l(8)||"";o.innerHTML=`
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><h1 style="margin:0 0 6px 0; font-size:1.25rem">${v(b)}</h1><span class="spinner" aria-hidden="true" title="Loading more details"></span></div>
        ${k?`<p style="margin:0 0 8px 0"><i>${v(k)}</i></p>`:""}
        <br/>
        <p style="margin:6px 0"><b>${v(I)}:</b> ${v(E)}</p>
        <p style="margin:6px 0"><b>${v(P)}:</b> ${v(Z)}</p>
        <br/>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(R=>String(R).trim().toUpperCase()==="F")||"Country")}:</b> ${v(oe)}</p>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(R=>String(R).trim().toUpperCase()==="G")||"Soviet Republic")}:</b> ${v(ie)}</p>
        <br/>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(R=>String(R).trim().toUpperCase()==="H")||"Gender")}:</b> ${v(z)}</p>
        <p style="margin:6px 0"><b>${v(Object.keys(s).find(R=>String(R).trim().toUpperCase()==="I")||"Notes")}:</b> ${v(W)}</p>
      </div>
    `,t&&(t.style.display="inline-block")}const L=["Composer","Lifespan","Country","Soviet republic","Nationality","Language","Notes","Learn more"],h={};if(Object.keys(r||{}).forEach(n=>{try{h[a(n)]=r[n]}catch{h[String(n||"")]=r[n]}}),u==="MusicList"){const n=(oe,ie=[])=>{for(const z of oe)if(r.hasOwnProperty(z)&&r[z]!==void 0&&r[z]!==null&&String(r[z]).trim()!=="")return String(r[z]);for(const z of ie)for(const W of Object.keys(r))if(String(W||"").toLowerCase().trim()===z.toLowerCase().trim()&&r[W])return String(r[W]);return""},l=n(["A","colA","Composer","composer","name"]),b=n(["B","colN","Lifespan","lifespan","Years"]),k=n(["C","colB","Russian","russian"]),E=n(["D","P","Label","label"]),I=n(["E","C","Value","native"]),S=n(["F","K","Country","country"]),P=n(["G","O","Soviet republic","republic"]),Z=n(["I","Q","Notes","notes"]);l&&(h.composer=l),b&&(h.lifespan=b),k&&(h.russian=k),E&&I&&(h[a(E)]=I),S&&(h.country=S),P&&(h["soviet republic"]=P),Z&&(h.notes=Z)}const w=n=>{for(const k of n){const E=a(k);if(E&&E in h&&h[E]!==void 0&&h[E]!==null&&String(h[E]).trim()!=="")return String(h[E])}const l=Object.values(h||{}).map(k=>k==null?"":String(k)),b=/\b\d{3,4}\s*[–—-]\s*\d{2,4}\b|\b\d{3,4}\b/;for(const k of l)if(k&&b.test(String(k)))return k;for(const k of l)if(k&&String(k).trim()!=="")return k;return""},O={Composer:["Composer","Композитор","composer","Name","name"],Lifespan:["Lifespan","Life span","Born","Died","Years"],Country:["Country","country","Страна","Country of birth","Nationality"],"Soviet republic":["Soviet republic","Republic","Soviet"],Nationality:["Nationality","Nationality (EN)"],Language:["Language","language","Язык"],Notes:["Notes","notes","Примечания"],"Learn more":["Learn more","Link","URL"]},H=L.map(n=>{const l=O[n]||[n],b=w(l);return b==null?"":String(b)}),$=L.indexOf("Lifespan"),U=$>=0&&H[$]||""||"",q=n=>String(n||"").replace(/[\r\n\t]+/g," ").replace(/\s+/g," ").trim();q(y);const V=q(U);u&&`${v(u)}`,V&&`${v(V)}`;const M=n=>{if(!n)return null;const l=String(n).trim().toLowerCase(),b=Object.keys(r).find(I=>String(I||"").trim().toLowerCase()===l);if(b)return b;const k=Object.keys(r).find(I=>String(I||"").toLowerCase().replace(/[^a-z0-9]/g,"")===("col"+l).replace(/[^a-z0-9]/g,""));if(k)return k;const E=Object.keys(r).find(I=>String(I||"").trim()===String(n).toUpperCase());if(E)return E;try{const I=String(n).toUpperCase().charCodeAt(0)-65;if(typeof d<"u"&&Array.isArray(d)&&I>=0&&I<d.length)return d[I]}catch{}return null},B=n=>{if(!n)return"";const l=r[n];return l==null?"":String(l)},me=B(M("A")),le=B(M("B")),ge=B(M("C")),re=M("D"),be=re?String(re):"D",he=B(M("E")),xe=B(M("F")),ve=B(M("G")),ke=B(M("H")),Ce=B(M("I")),Le=M("C")||"Russian";let se=be;try{r&&Object.keys(r)[3]&&r[Object.keys(r)[3]]&&(se=String(r[Object.keys(r)[3]]))}catch{}const Se=M("F")||"Country",Ee=M("G")||"Soviet Republic",Ae=M("H")||"Gender",we=M("I")||"Notes";o.innerHTML=`
    <div>
      <h1 style="margin:0 0 6px 0; font-size:1.25rem">${v(me)}</h1>
      ${le?`<p style="margin:0 0 8px 0"><i>${v(le)}</i></p>`:""}
  <br/>
  <p style="margin:6px 0"><b>${v(Le)}:</b> ${v(ge)}</p>
  <p style="margin:6px 0"><b>${v(se)}:</b> ${v(he)}</p>
  <br/>
  <p style="margin:6px 0"><b>${v(Se)}:</b> ${v(xe)}</p>
  <p style="margin:6px 0"><b>${v(Ee)}:</b> ${v(ve)}</p>
  <br/>
  <p style="margin:6px 0"><b>${v(Ae)}:</b> ${v(ke)}</p>
  <p style="margin:6px 0"><b>${v(we)}:</b> ${v(Ce)}</p>
    </div>
    `,t&&(t.style.display="inline-block",t.onclick=()=>{N="",t&&(t.style.display="none"),K("",null),C=1,T()})}(async function(){try{const s=document.getElementById("results-list");s&&(s.innerHTML='<div class="result-item"><em>Loading results…</em></div>');const o=document.getElementById("filter-country");o&&(o.innerHTML='<div style="color:#6b7280">Loading…</div>');const t=document.getElementById("filter-decade");t&&(t.innerHTML='<div style="color:#6b7280">Loading…</div>');const a=document.getElementById("filter-type");a&&(a.innerHTML='<div style="color:#6b7280">Loading…</div>'),await Promise.allSettled([$e(),Be(),Me()]);const g=document.getElementById("qbtn");g&&g.addEventListener("click",()=>{C=1,T()}),J&&J.addEventListener("keydown",m=>{m.key==="Enter"&&(C=1,T())});try{const m=document.getElementById("clear-all-filters-btn");m&&m.addEventListener("click",()=>{ce()})}catch{}try{K("",null)}catch{}await T()}catch(s){const o=document.getElementById("results");o&&(o.innerText="Initialization failed: "+String(s)),console.error("Initialization failed",s)}})();
