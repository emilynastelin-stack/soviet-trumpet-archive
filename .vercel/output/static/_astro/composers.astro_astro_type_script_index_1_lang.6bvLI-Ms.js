let r=null,p=localStorage.getItem("locale")||"en";const u=document.getElementById("langBtn"),d=document.getElementById("langDropdown"),G=document.getElementById("langToggle");async function P(){try{r=await(await fetch("/i18n/translations.json")).json()}catch(e){console.error("Failed to load translations",e),r=null}}function H(e){p=e,localStorage.setItem("locale",e);const n=(r&&r[e]?r[e]:r&&r.en?r.en:null)||{placeholder:"Search composers, countries, or pieces...",search:"Search",showAll:"Show All",reset:"Reset Filters",loading:"Loading…",enterSearch:'Enter a search or click "Show All" to display results.',labels:{native:"Native",compositions:"Composition(s)",year:"Year",type:"Type",nationality:"Nationality",country:"Country",gender:"Gender",leader:"Leader",source:"Source"},navEnglish:"Archive of Soviet Trumpet Music",heroTitle:"Discover Soviet-era trumpet music",heroSubtitle:"Search composers and pieces from across the Soviet republics.",decades:["1920s","1930s","1940s","1950s","1960s","1970s","1980s"],countries:["Russia","Ukraine","Belarus","Armenia","Georgia","Latvia","Estonia","Lithuania","Kazakhstan","Uzbekistan","Other"],genderOptions:["Male","Female","Other"]};y.placeholder=n.placeholder,R.textContent=n.search,M.textContent=n.showAll,document.getElementById("resetFilters").textContent=n.reset,document.getElementById("resultsCount").textContent="",m.textContent="",i.innerHTML=`<div class="muted">${n.enterSearch}</div>`,u.textContent=e==="en"?"EN ▾":"DE ▾",document.getElementById("navEnglish").textContent=n.navEnglish||document.getElementById("navEnglish").textContent;const l=document.querySelector(".search-panel h1"),s=document.querySelector(".search-panel p.muted");l&&(l.textContent=n.heroTitle||l.textContent),s&&(s.textContent=n.heroSubtitle||s.textContent);const c=document.getElementById("decadeFilter"),L=document.getElementById("countryFilter"),$=document.getElementById("genderFilter");function k(B,F,S,I){if(!B)return;let T=`<option value="All">${n&&n[I]?n[I]:I}</option>`;for(let A=0;A<F.length;A++){const D=F[A],z=S&&S[A]?S[A]:D;T+=`<option value="${encodeURIComponent(String(D))}">${z}</option>`}B.innerHTML=T}const g=r&&r.en?r.en:null,U=g?g.decades:n.decades||[],j=g?g.countries:n.countries||[],N=g?g.genderOptions:n.genderOptions||[];k(c,U,n.decades,"filterDecade"),k(L,j,n.countries,"filterCountry"),k($,N,n.genderOptions,"filterGender"),a&&a.length&&(x||document.getElementById("results").children.length>0)&&C()}u.addEventListener("click",e=>{d.classList.toggle("open"),u.setAttribute("aria-expanded",d.classList.contains("open"))});u.setAttribute("aria-haspopup","listbox");u.setAttribute("aria-expanded","false");u.addEventListener("keydown",e=>{(e.key==="ArrowDown"||e.key==="Enter"||e.key===" ")&&(e.preventDefault(),d.classList.add("open"),d.querySelector(".lang-option").focus())});d.addEventListener("click",e=>{const o=e.target.closest(".lang-option");if(!o)return;const t=o.dataset.locale;H(t),d.classList.remove("open"),u.setAttribute("aria-expanded","false")});d.addEventListener("keydown",e=>{const o=Array.from(d.querySelectorAll(".lang-option")),t=o.indexOf(document.activeElement);if(e.key==="ArrowDown"){e.preventDefault();const n=o[(t+1)%o.length];n&&n.focus()}if(e.key==="ArrowUp"){e.preventDefault();const n=o[(t-1+o.length)%o.length];n&&n.focus()}(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),document.activeElement.click()),e.key==="Escape"&&(d.classList.remove("open"),u.focus())});document.addEventListener("click",e=>{G.contains(e.target)||(d.classList.remove("open"),u.setAttribute("aria-expanded","false"))});function h(e){if(!e)return"";try{return e.toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase()}catch{return e.toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}}const y=document.getElementById("q"),R=document.getElementById("searchBtn"),M=document.getElementById("showAll"),f=document.getElementById("genderFilter"),v=document.getElementById("decadeFilter"),E=document.getElementById("countryFilter"),i=document.getElementById("results"),b=document.getElementById("resultsCount"),m=document.getElementById("statusMsg");let a=[],V=[],x=!1;async function w(){m.innerHTML='<span class="spinner"><svg viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg"><circle cx="25" cy="25" r="20" fill="none" stroke="#8b0000" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4"/></svg></span>Loading…';try{const e=(window.location&&window.location.origin?window.location.origin:"")+"/api/sheets?_="+Date.now(),o=await fetch(e,{method:"GET",mode:"same-origin",cache:"no-store"});if(!o.ok){const n=await o.text();throw new Error("Fetch failed: "+o.status+" "+n)}const t=await o.json();if(!Array.isArray(t)||t.length===0){a=[],i.innerHTML='<div class="muted">No data available</div>',m.textContent="",b.textContent="";return}a=t,V=Object.keys(a[0]||{}),m.textContent="",b.textContent="",i.innerHTML='<div class="muted">Enter a search or click "Show All" to display results.</div>'}catch(e){console.error(e),m.textContent="Failed to load data",i.innerHTML=`<div class="muted">Error loading data: ${String(e)}</div>`}}function C(){x=!0;const e=h(y.value||""),o=f.value||"All",t=v.value||"All",n=E.value||"All";let l=a.slice();e&&(l=l.filter(s=>h(Object.values(s||{}).join(" ")).includes(e))),o!=="All"&&(l=l.filter(s=>h(s.Gender||s.gender||"").includes(h(o)))),t!=="All"&&(l=l.filter(s=>(s.Decade||"").toString()===t)),n!=="All"&&(l=l.filter(s=>h(s.Country||s.Nationality||"").includes(h(n)))),_()}function Y(){try{(i&&i.querySelectorAll?i.querySelectorAll(".card"):document.querySelectorAll(".card")).forEach(o=>{const t=o.querySelector(".card-content"),n=o.querySelector(".card-header");if(t)if(o.classList.contains("open"))t.style.display="block",t.style.pointerEvents="",t.style.opacity="0",t.style.maxHeight="0px",requestAnimationFrame(()=>{try{t.style.maxHeight=(t.scrollHeight||t.offsetHeight||0)+"px",t.style.opacity="1"}catch{}}),n&&n.setAttribute("aria-expanded","true");else{try{t.style.pointerEvents="none",t.style.opacity="0",t.style.maxHeight=(t.scrollHeight||t.offsetHeight||0)+"px",t.offsetHeight,requestAnimationFrame(()=>{t.style.maxHeight="0px"});const l=function(){try{t.style.display="none"}catch{}finally{t.removeEventListener("transitionend",l)}};t.addEventListener("transitionend",l)}catch{t.style.display="none",t.style.maxHeight="0px",t.style.opacity="0"}n&&n.setAttribute("aria-expanded","false")}})}catch{}}function _(e){r&&r[p]?r[p]:r&&r.en&&r.en,i.innerHTML="";const o=document.createElement("div");o.innerHTML=`
    <div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #eee;">
      <p style="margin:0 0 8px">Results are shown on a dedicated page. Click the button below to open a plain results view (unstyled).</p>
      <div><button id="openResultsInline" class="small-btn">Open results page</button></div>
    </div>`,i.appendChild(o);const t=document.getElementById("openResultsInline");t&&t.addEventListener("click",()=>{const n=encodeURIComponent(y.value||""),l=encodeURIComponent(f.value||"All"),s=encodeURIComponent(v.value||"All"),c=encodeURIComponent(E.value||"All"),L=`/composers-results?q=${n}&gender=${l}&decade=${s}&country=${c}`;window.location.href=L})}function O(){const e=encodeURIComponent(y.value||""),o=encodeURIComponent(f.value||"All"),t=encodeURIComponent(v.value||"All"),n=encodeURIComponent(E.value||"All"),l=`/composers-results?q=${e}&gender=${o}&decade=${t}&country=${n}`;window.location.href=l}R.addEventListener("click",O);y.addEventListener("keydown",e=>{e.key==="Enter"&&O()});f.addEventListener("change",C);v.addEventListener("change",C);E.addEventListener("change",C);M.addEventListener("click",()=>{y.value="",f.value="All",v.value="All",E.value="All",x=!0;const e="/composers-results?q=&gender=All&decade=All&country=All";window.location.href=e});const J=document.getElementById("resetFilters");J.addEventListener("click",()=>{y.value="",f.value="All",v.value="All",E.value="All",x=!1,i.innerHTML='<div class="muted">Enter a search or click "Show All" to display results.</div>',b.textContent="",m.textContent="";try{Y()}catch{}});(async function(){try{r||await P();try{H(p)}catch(e){console.error("applyLocale failed",e)}m.textContent=r&&r[p]&&r[p].loading?r[p].loading:"Loading…",await w()}catch(e){console.error("Initial load error",e),m.textContent="Initialization failed",i.innerHTML=`<div class="muted">Initialization error: ${String(e)}</div>`}})();setTimeout(()=>{if(!a||a.length===0)try{w()}catch(e){console.error("watchdog fetch failed",e)}},1e3);if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{try{w()}catch{}});else try{w()}catch{}const q=Array.from(document.querySelectorAll(".cta-add")).find(e=>/randomize/i.test(e.textContent||""));q&&q.addEventListener("click",async e=>{e.preventDefault();try{if((!a||a.length===0)&&await w(),!a||a.length===0)return;const o=a.find(c=>c&&Object.keys(c).length);let t=null;if(o){for(const c of Object.keys(o))if(/composer/i.test(c)||/композитор/i.test(c)){t=c;break}}t||(t=Object.keys(a[0])[0]);const n=a.map(c=>c&&c[t]?String(c[t]).trim():"").filter(Boolean);if(!n||n.length===0)return;const l=n[Math.floor(Math.random()*n.length)],s=`/composers-results?q=${encodeURIComponent(l)}&random=1`;window.location.href=s}catch(o){console.error("Randomize redirect failed",o)}});
